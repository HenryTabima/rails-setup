<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Active Record Query Interface · Rails Setup</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;p&gt;This guide covers different ways to retrieve data from the database using Active Record.&lt;/p&gt;
"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Active Record Query Interface · Rails Setup"/><meta property="og:type" content="website"/><meta property="og:url" content="https://HenryTabima.github.io/rails-setup/"/><meta property="og:description" content="&lt;p&gt;This guide covers different ways to retrieve data from the database using Active Record.&lt;/p&gt;
"/><meta property="og:image" content="https://HenryTabima.github.io/rails-setup/img/undraw_online.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://HenryTabima.github.io/rails-setup/img/undraw_tweetstorm.svg"/><link rel="shortcut icon" href="/rails-setup/img/favicon.ico"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/rails-setup/js/scrollSpy.js"></script><link rel="stylesheet" href="/rails-setup/css/main.css"/><script src="/rails-setup/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/rails-setup/"><img class="logo" src="/rails-setup/img/favicon.ico" alt="Rails Setup"/><h2 class="headerTitleWithLogo">Rails Setup</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/rails-setup/docs/rails/getting-started" target="_self">Rails</a></li><li class=""><a href="/rails-setup/docs/devise/overview" target="_self">Devise</a></li><li class=""><a href="https://github.com/HenryTabima/rails-setup" target="_self">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Models</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Start Here<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/getting-started">Getting Started with Rails</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/development-dependencies-install">Development Dependencies Install</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Models<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/active-record-basics">Active Record Basics</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/active-record-migrations">Active Record Migrations</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/active-record-validations">Active Record Validations</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/active-record-callbacks">Active Record Callbacks</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/active-record-associations">Active Record Associations</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/rails-setup/docs/rails/active-record-query">Active Record Query Interface</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/multiple-databases">Multiple Databases with Active Record</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/active-record-postgresql">Active Record and PostgreSQL</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Views<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/layouts-and-rendering">Layouts and Rendering in Rails</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/action-view">Action View Overview</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/action-view-form-helpers">Action View Form Helpers</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Controllers<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/action-controller">Action Controller Overview</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/rails-routing">Rails Routing from the Outside In</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Other Components<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/active-support-core">Active Support Core Extensions</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/active-support-instrumentation">Active Support Instrumentation</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/action-mailer">Action Mailer Basics</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/action-mailbox">Action Mailbox Basics</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/active-model">Active Model Basics</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/active-job">Active Job Basics</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/action-text">Action Text Overview</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/active-storage">Active Storage Overview</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/action-cable">Action Cable Overview</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Digging Deeper<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/rails-i18n">Rails Internationalization (I18n) API</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/testing-rails">Testing Rails Applications</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/securing-rails">Securing Rails Applications</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/debugging-rails">Debugging Rails Applications</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/configuring-rails">Configuring Rails Applications</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/rails-command-line">The Rails Command Line</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/asset-pipeline">The Asset Pipeline</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/working-with-javascript">Working with JavaScript in Rails</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/autoloading-and-reloading">Autoloading and Reloading Constants</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/caching-with-rails">Caching with Rails: An Overview</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/api-only-apps">Using Rails for API-only Applications</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/threading">Threading and Code Execution in Rails</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/initialization">The Rails Initialization Process</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/engines">Getting Started with Engines</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Extending Rails<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/rails-on-rack">Rails on Rack</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/generators-&amp;-templates">Creating and Customizing Rails Generators &amp; Templates</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/application-templates">Rails Application Templates</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/creating-rails-plugins">The Basics of Creating Rails Plugins</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Contributions<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/contributing-to-rails">Contributing to Ruby on Rails</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/api-documentation">API Documentation Guidelines</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/guides-guidelines">Ruby on Rails Guides Guidelines</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Policies<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails/maintenance-policy">Maintenance Policy for Ruby on Rails</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Active Record Query Interface</h1></header><article><div><span><p>This guide covers different ways to retrieve data from the database using Active Record.</p>
<p>After reading this guide, you will know:</p>
<ul>
<li>How to find records using a variety of methods and conditions.</li>
<li>How to specify the order, retrieved attributes, grouping, and other properties of the found records.</li>
<li>How to use eager loading to reduce the number of database queries needed for data retrieval.</li>
<li>How to use dynamic finder methods.</li>
<li>How to use method chaining to use multiple Active Record methods together.</li>
<li>How to check for the existence of particular records.</li>
<li>How to perform various calculations on Active Record models.</li>
<li>How to run EXPLAIN on relations.</li>
</ul>
<hr>
<p>If you're used to using raw SQL to find database records, then you will generally find that there are better ways to carry out the same operations in Rails. Active Record insulates you from the need to use SQL in most cases.</p>
<p>Code examples throughout this guide will refer to one or more of the following models:</p>
<p>TIP: All of the following models use <code>id</code> as the primary key, unless specified otherwise.</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Client</span> &lt; ApplicationRecord</span>
  has_one <span class="hljs-symbol">:address</span>
  has_many <span class="hljs-symbol">:orders</span>
  has_and_belongs_to_many <span class="hljs-symbol">:roles</span>
<span class="hljs-keyword">end</span>
</code></pre>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Address</span> &lt; ApplicationRecord</span>
  belongs_to <span class="hljs-symbol">:client</span>
<span class="hljs-keyword">end</span>
</code></pre>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Order</span> &lt; ApplicationRecord</span>
  belongs_to <span class="hljs-symbol">:client</span>, <span class="hljs-symbol">counter_cache:</span> <span class="hljs-literal">true</span>
<span class="hljs-keyword">end</span>
</code></pre>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Role</span> &lt; ApplicationRecord</span>
  has_and_belongs_to_many <span class="hljs-symbol">:clients</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>Active Record will perform queries on the database for you and is compatible with most database systems, including MySQL, MariaDB, PostgreSQL, and SQLite. Regardless of which database system you're using, the Active Record method format will always be the same.</p>
<h2><a class="anchor" aria-hidden="true" id="retrieving-objects-from-the-database"></a><a href="#retrieving-objects-from-the-database" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Retrieving Objects from the Database</h2>
<p>To retrieve objects from the database, Active Record provides several finder methods. Each finder method allows you to pass arguments into it to perform certain queries on your database without writing raw SQL.</p>
<p>The methods are:</p>
<ul>
<li><code>annotate</code></li>
<li><code>find</code></li>
<li><code>create_with</code></li>
<li><code>distinct</code></li>
<li><code>eager_load</code></li>
<li><code>extending</code></li>
<li><code>extract_associated</code></li>
<li><code>from</code></li>
<li><code>group</code></li>
<li><code>having</code></li>
<li><code>includes</code></li>
<li><code>joins</code></li>
<li><code>left_outer_joins</code></li>
<li><code>limit</code></li>
<li><code>lock</code></li>
<li><code>none</code></li>
<li><code>offset</code></li>
<li><code>optimizer_hints</code></li>
<li><code>order</code></li>
<li><code>preload</code></li>
<li><code>readonly</code></li>
<li><code>references</code></li>
<li><code>reorder</code></li>
<li><code>reselect</code></li>
<li><code>reverse_order</code></li>
<li><code>select</code></li>
<li><code>where</code></li>
</ul>
<p>Finder methods that return a collection, such as <code>where</code> and <code>group</code>, return an instance of <code>ActiveRecord::Relation</code>.  Methods that find a single entity, such as <code>find</code> and <code>first</code>, return a single instance of the model.</p>
<p>The primary operation of <code>Model.find(options)</code> can be summarized as:</p>
<ul>
<li>Convert the supplied options to an equivalent SQL query.</li>
<li>Fire the SQL query and retrieve the corresponding results from the database.</li>
<li>Instantiate the equivalent Ruby object of the appropriate model for every resulting row.</li>
<li>Run <code>after_find</code> and then <code>after_initialize</code> callbacks, if any.</li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="retrieving-a-single-object"></a><a href="#retrieving-a-single-object" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Retrieving a Single Object</h3>
<p>Active Record provides several different ways of retrieving a single object.</p>
<h4><a class="anchor" aria-hidden="true" id="find"></a><a href="#find" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>find</code></h4>
<p>Using the <code>find</code> method, you can retrieve the object corresponding to the specified <em>primary key</em> that matches any supplied options. For example:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-comment"># Find the client with primary key (id) 10.</span>
client = Client.find(<span class="hljs-number">10</span>)
<span class="hljs-comment"># =&gt; #&lt;Client id: 10, first_name: "Ryan"&gt;</span>
</code></pre>
<p>The SQL equivalent of the above is:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> clients <span class="hljs-keyword">WHERE</span> (clients.id = <span class="hljs-number">10</span>) <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>
</code></pre>
<p>The <code>find</code> method will raise an <code>ActiveRecord::RecordNotFound</code> exception if no matching record is found.</p>
<p>You can also use this method to query for multiple objects. Call the <code>find</code> method and pass in an array of primary keys. The return will be an array containing all of the matching records for the supplied <em>primary keys</em>. For example:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-comment"># Find the clients with primary keys 1 and 10.</span>
clients = Client.find([<span class="hljs-number">1</span>, <span class="hljs-number">10</span>]) <span class="hljs-comment"># Or even Client.find(1, 10)</span>
<span class="hljs-comment"># =&gt; [#&lt;Client id: 1, first_name: "Lifo"&gt;, #&lt;Client id: 10, first_name: "Ryan"&gt;]</span>
</code></pre>
<p>The SQL equivalent of the above is:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> clients <span class="hljs-keyword">WHERE</span> (clients.id <span class="hljs-keyword">IN</span> (<span class="hljs-number">1</span>,<span class="hljs-number">10</span>))
</code></pre>
<p>WARNING: The <code>find</code> method will raise an <code>ActiveRecord::RecordNotFound</code> exception unless a matching record is found for <strong>all</strong> of the supplied primary keys.</p>
<h4><a class="anchor" aria-hidden="true" id="take"></a><a href="#take" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>take</code></h4>
<p>The <code>take</code> method retrieves a record without any implicit ordering. For example:</p>
<pre><code class="hljs css language-ruby">client = Client.take
<span class="hljs-comment"># =&gt; #&lt;Client id: 1, first_name: "Lifo"&gt;</span>
</code></pre>
<p>The SQL equivalent of the above is:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> clients <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>
</code></pre>
<p>The <code>take</code> method returns <code>nil</code> if no record is found and no exception will be raised.</p>
<p>You can pass in a numerical argument to the <code>take</code> method to return up to that number of results. For example</p>
<pre><code class="hljs css language-ruby">clients = Client.take(<span class="hljs-number">2</span>)
<span class="hljs-comment"># =&gt; [</span>
<span class="hljs-comment">#   #&lt;Client id: 1, first_name: "Lifo"&gt;,</span>
<span class="hljs-comment">#   #&lt;Client id: 220, first_name: "Sara"&gt;</span>
<span class="hljs-comment"># ]</span>
</code></pre>
<p>The SQL equivalent of the above is:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> clients <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">2</span>
</code></pre>
<p>The <code>take!</code> method behaves exactly like <code>take</code>, except that it will raise <code>ActiveRecord::RecordNotFound</code> if no matching record is found.</p>
<p>TIP: The retrieved record may vary depending on the database engine.</p>
<h4><a class="anchor" aria-hidden="true" id="first"></a><a href="#first" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>first</code></h4>
<p>The <code>first</code> method finds the first record ordered by primary key (default). For example:</p>
<pre><code class="hljs css language-ruby">client = Client.first
<span class="hljs-comment"># =&gt; #&lt;Client id: 1, first_name: "Lifo"&gt;</span>
</code></pre>
<p>The SQL equivalent of the above is:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> clients <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> clients.id <span class="hljs-keyword">ASC</span> <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>
</code></pre>
<p>The <code>first</code> method returns <code>nil</code> if no matching record is found and no exception will be raised.</p>
<p>If your <a href="active_record_querying.html#applying-a-default-scope">default scope</a> contains an order method, <code>first</code> will return the first record according to this ordering.</p>
<p>You can pass in a numerical argument to the <code>first</code> method to return up to that number of results. For example</p>
<pre><code class="hljs css language-ruby">clients = Client.first(<span class="hljs-number">3</span>)
<span class="hljs-comment"># =&gt; [</span>
<span class="hljs-comment">#   #&lt;Client id: 1, first_name: "Lifo"&gt;,</span>
<span class="hljs-comment">#   #&lt;Client id: 2, first_name: "Fifo"&gt;,</span>
<span class="hljs-comment">#   #&lt;Client id: 3, first_name: "Filo"&gt;</span>
<span class="hljs-comment"># ]</span>
</code></pre>
<p>The SQL equivalent of the above is:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> clients <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> clients.id <span class="hljs-keyword">ASC</span> <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">3</span>
</code></pre>
<p>On a collection that is ordered using <code>order</code>, <code>first</code> will return the first record ordered by the specified attribute for <code>order</code>.</p>
<pre><code class="hljs css language-ruby">client = Client.order(<span class="hljs-symbol">:first_name</span>).first
<span class="hljs-comment"># =&gt; #&lt;Client id: 2, first_name: "Fifo"&gt;</span>
</code></pre>
<p>The SQL equivalent of the above is:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> clients <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> clients.first_name <span class="hljs-keyword">ASC</span> <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>
</code></pre>
<p>The <code>first!</code> method behaves exactly like <code>first</code>, except that it will raise <code>ActiveRecord::RecordNotFound</code> if no matching record is found.</p>
<h4><a class="anchor" aria-hidden="true" id="last"></a><a href="#last" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>last</code></h4>
<p>The <code>last</code> method finds the last record ordered by primary key (default). For example:</p>
<pre><code class="hljs css language-ruby">client = Client.last
<span class="hljs-comment"># =&gt; #&lt;Client id: 221, first_name: "Russel"&gt;</span>
</code></pre>
<p>The SQL equivalent of the above is:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> clients <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> clients.id <span class="hljs-keyword">DESC</span> <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>
</code></pre>
<p>The <code>last</code> method returns <code>nil</code> if no matching record is found and no exception will be raised.</p>
<p>If your <a href="active_record_querying.html#applying-a-default-scope">default scope</a> contains an order method, <code>last</code> will return the last record according to this ordering.</p>
<p>You can pass in a numerical argument to the <code>last</code> method to return up to that number of results. For example</p>
<pre><code class="hljs css language-ruby">clients = Client.last(<span class="hljs-number">3</span>)
<span class="hljs-comment"># =&gt; [</span>
<span class="hljs-comment">#   #&lt;Client id: 219, first_name: "James"&gt;,</span>
<span class="hljs-comment">#   #&lt;Client id: 220, first_name: "Sara"&gt;,</span>
<span class="hljs-comment">#   #&lt;Client id: 221, first_name: "Russel"&gt;</span>
<span class="hljs-comment"># ]</span>
</code></pre>
<p>The SQL equivalent of the above is:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> clients <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> clients.id <span class="hljs-keyword">DESC</span> <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">3</span>
</code></pre>
<p>On a collection that is ordered using <code>order</code>, <code>last</code> will return the last record ordered by the specified attribute for <code>order</code>.</p>
<pre><code class="hljs css language-ruby">client = Client.order(<span class="hljs-symbol">:first_name</span>).last
<span class="hljs-comment"># =&gt; #&lt;Client id: 220, first_name: "Sara"&gt;</span>
</code></pre>
<p>The SQL equivalent of the above is:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> clients <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> clients.first_name <span class="hljs-keyword">DESC</span> <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>
</code></pre>
<p>The <code>last!</code> method behaves exactly like <code>last</code>, except that it will raise <code>ActiveRecord::RecordNotFound</code> if no matching record is found.</p>
<h4><a class="anchor" aria-hidden="true" id="find_by"></a><a href="#find_by" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>find_by</code></h4>
<p>The <code>find_by</code> method finds the first record matching some conditions. For example:</p>
<pre><code class="hljs css language-ruby">Client.find_by <span class="hljs-symbol">first_name:</span> <span class="hljs-string">'Lifo'</span>
<span class="hljs-comment"># =&gt; #&lt;Client id: 1, first_name: "Lifo"&gt;</span>

Client.find_by <span class="hljs-symbol">first_name:</span> <span class="hljs-string">'Jon'</span>
<span class="hljs-comment"># =&gt; nil</span>
</code></pre>
<p>It is equivalent to writing:</p>
<pre><code class="hljs css language-ruby">Client.where(<span class="hljs-symbol">first_name:</span> <span class="hljs-string">'Lifo'</span>).take
</code></pre>
<p>The SQL equivalent of the above is:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> clients <span class="hljs-keyword">WHERE</span> (clients.first_name = <span class="hljs-string">'Lifo'</span>) <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>
</code></pre>
<p>The <code>find_by!</code> method behaves exactly like <code>find_by</code>, except that it will raise <code>ActiveRecord::RecordNotFound</code> if no matching record is found. For example:</p>
<pre><code class="hljs css language-ruby">Client.find_by! <span class="hljs-symbol">first_name:</span> <span class="hljs-string">'does not exist'</span>
<span class="hljs-comment"># =&gt; ActiveRecord::RecordNotFound</span>
</code></pre>
<p>This is equivalent to writing:</p>
<pre><code class="hljs css language-ruby">Client.where(<span class="hljs-symbol">first_name:</span> <span class="hljs-string">'does not exist'</span>).take!
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="retrieving-multiple-objects-in-batches"></a><a href="#retrieving-multiple-objects-in-batches" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Retrieving Multiple Objects in Batches</h3>
<p>We often need to iterate over a large set of records, as when we send a newsletter to a large set of users, or when we export data.</p>
<p>This may appear straightforward:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-comment"># This may consume too much memory if the table is big.</span>
User.all.each <span class="hljs-keyword">do</span> <span class="hljs-params">|user|</span>
  NewsMailer.weekly(user).deliver_now
<span class="hljs-keyword">end</span>
</code></pre>
<p>But this approach becomes increasingly impractical as the table size increases, since <code>User.all.each</code> instructs Active Record to fetch <em>the entire table</em> in a single pass, build a model object per row, and then keep the entire array of model objects in memory. Indeed, if we have a large number of records, the entire collection may exceed the amount of memory available.</p>
<p>Rails provides two methods that address this problem by dividing records into memory-friendly batches for processing. The first method, <code>find_each</code>, retrieves a batch of records and then yields <em>each</em> record to the block individually as a model. The second method, <code>find_in_batches</code>, retrieves a batch of records and then yields <em>the entire batch</em> to the block as an array of models.</p>
<p>TIP: The <code>find_each</code> and <code>find_in_batches</code> methods are intended for use in the batch processing of a large number of records that wouldn't fit in memory all at once. If you just need to loop over a thousand records the regular find methods are the preferred option.</p>
<h4><a class="anchor" aria-hidden="true" id="find_each"></a><a href="#find_each" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>find_each</code></h4>
<p>The <code>find_each</code> method retrieves records in batches and then yields <em>each</em> one to the block. In the following example, <code>find_each</code> retrieves users in batches of 1000 and yields them to the block one by one:</p>
<pre><code class="hljs css language-ruby">User.find_each <span class="hljs-keyword">do</span> <span class="hljs-params">|user|</span>
  NewsMailer.weekly(user).deliver_now
<span class="hljs-keyword">end</span>
</code></pre>
<p>This process is repeated, fetching more batches as needed, until all of the records have been processed.</p>
<p><code>find_each</code> works on model classes, as seen above, and also on relations:</p>
<pre><code class="hljs css language-ruby">User.where(<span class="hljs-symbol">weekly_subscriber:</span> <span class="hljs-literal">true</span>).find_each <span class="hljs-keyword">do</span> <span class="hljs-params">|user|</span>
  NewsMailer.weekly(user).deliver_now
<span class="hljs-keyword">end</span>
</code></pre>
<p>as long as they have no ordering, since the method needs to force an order
internally to iterate.</p>
<p>If an order is present in the receiver the behaviour depends on the flag
<code>config.active_record.error_on_ignored_order</code>. If true, <code>ArgumentError</code> is
raised, otherwise the order is ignored and a warning issued, which is the
default. This can be overridden with the option <code>:error_on_ignore</code>, explained
below.</p>
<h5><a class="anchor" aria-hidden="true" id="options-for-find_each"></a><a href="#options-for-find_each" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Options for <code>find_each</code></h5>
<p><strong><code>:batch_size</code></strong></p>
<p>The <code>:batch_size</code> option allows you to specify the number of records to be retrieved in each batch, before being passed individually to the block. For example, to retrieve records in batches of 5000:</p>
<pre><code class="hljs css language-ruby">User.find_each(<span class="hljs-symbol">batch_size:</span> <span class="hljs-number">5000</span>) <span class="hljs-keyword">do</span> <span class="hljs-params">|user|</span>
  NewsMailer.weekly(user).deliver_now
<span class="hljs-keyword">end</span>
</code></pre>
<p><strong><code>:start</code></strong></p>
<p>By default, records are fetched in ascending order of the primary key. The <code>:start</code> option allows you to configure the first ID of the sequence whenever the lowest ID is not the one you need. This would be useful, for example, if you wanted to resume an interrupted batch process, provided you saved the last processed ID as a checkpoint.</p>
<p>For example, to send newsletters only to users with the primary key starting from 2000:</p>
<pre><code class="hljs css language-ruby">User.find_each(<span class="hljs-symbol">start:</span> <span class="hljs-number">2000</span>) <span class="hljs-keyword">do</span> <span class="hljs-params">|user|</span>
  NewsMailer.weekly(user).deliver_now
<span class="hljs-keyword">end</span>
</code></pre>
<p><strong><code>:finish</code></strong></p>
<p>Similar to the <code>:start</code> option, <code>:finish</code> allows you to configure the last ID of the sequence whenever the highest ID is not the one you need.
This would be useful, for example, if you wanted to run a batch process using a subset of records based on <code>:start</code> and <code>:finish</code>.</p>
<p>For example, to send newsletters only to users with the primary key starting from 2000 up to 10000:</p>
<pre><code class="hljs css language-ruby">User.find_each(<span class="hljs-symbol">start:</span> <span class="hljs-number">2000</span>, <span class="hljs-symbol">finish:</span> <span class="hljs-number">10000</span>) <span class="hljs-keyword">do</span> <span class="hljs-params">|user|</span>
  NewsMailer.weekly(user).deliver_now
<span class="hljs-keyword">end</span>
</code></pre>
<p>Another example would be if you wanted multiple workers handling the same
processing queue. You could have each worker handle 10000 records by setting the
appropriate <code>:start</code> and <code>:finish</code> options on each worker.</p>
<p><strong><code>:error_on_ignore</code></strong></p>
<p>Overrides the application config to specify if an error should be raised when an
order is present in the relation.</p>
<h4><a class="anchor" aria-hidden="true" id="find_in_batches"></a><a href="#find_in_batches" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>find_in_batches</code></h4>
<p>The <code>find_in_batches</code> method is similar to <code>find_each</code>, since both retrieve batches of records. The difference is that <code>find_in_batches</code> yields <em>batches</em> to the block as an array of models, instead of individually. The following example will yield to the supplied block an array of up to 1000 invoices at a time, with the final block containing any remaining invoices:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-comment"># Give add_invoices an array of 1000 invoices at a time.</span>
Invoice.find_in_batches <span class="hljs-keyword">do</span> <span class="hljs-params">|invoices|</span>
  export.add_invoices(invoices)
<span class="hljs-keyword">end</span>
</code></pre>
<p><code>find_in_batches</code> works on model classes, as seen above, and also on relations:</p>
<pre><code class="hljs css language-ruby">Invoice.pending.find_in_batches <span class="hljs-keyword">do</span> <span class="hljs-params">|invoices|</span>
  pending_invoices_export.add_invoices(invoices)
<span class="hljs-keyword">end</span>
</code></pre>
<p>as long as they have no ordering, since the method needs to force an order
internally to iterate.</p>
<h5><a class="anchor" aria-hidden="true" id="options-for-find_in_batches"></a><a href="#options-for-find_in_batches" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Options for <code>find_in_batches</code></h5>
<p>The <code>find_in_batches</code> method accepts the same options as <code>find_each</code>.</p>
<h2><a class="anchor" aria-hidden="true" id="conditions"></a><a href="#conditions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conditions</h2>
<p>The <code>where</code> method allows you to specify conditions to limit the records returned, representing the <code>WHERE</code>-part of the SQL statement. Conditions can either be specified as a string, array, or hash.</p>
<h3><a class="anchor" aria-hidden="true" id="pure-string-conditions"></a><a href="#pure-string-conditions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Pure String Conditions</h3>
<p>If you'd like to add conditions to your find, you could just specify them in there, just like <code>Client.where(&quot;orders_count = '2'&quot;)</code>. This will find all clients where the <code>orders_count</code> field's value is 2.</p>
<p>WARNING: Building your own conditions as pure strings can leave you vulnerable to SQL injection exploits. For example, <code>Client.where(&quot;first_name LIKE '%#{params[:first_name]}%'&quot;)</code> is not safe. See the next section for the preferred way to handle conditions using an array.</p>
<h3><a class="anchor" aria-hidden="true" id="array-conditions"></a><a href="#array-conditions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Array Conditions</h3>
<p>Now what if that number could vary, say as an argument from somewhere? The find would then take the form:</p>
<pre><code class="hljs css language-ruby">Client.where(<span class="hljs-string">"orders_count = ?"</span>, params[<span class="hljs-symbol">:orders</span>])
</code></pre>
<p>Active Record will take the first argument as the conditions string and any additional arguments will replace the question marks <code>(?)</code> in it.</p>
<p>If you want to specify multiple conditions:</p>
<pre><code class="hljs css language-ruby">Client.where(<span class="hljs-string">"orders_count = ? AND locked = ?"</span>, params[<span class="hljs-symbol">:orders</span>], <span class="hljs-literal">false</span>)
</code></pre>
<p>In this example, the first question mark will be replaced with the value in <code>params[:orders]</code> and the second will be replaced with the SQL representation of <code>false</code>, which depends on the adapter.</p>
<p>This code is highly preferable:</p>
<pre><code class="hljs css language-ruby">Client.where(<span class="hljs-string">"orders_count = ?"</span>, params[<span class="hljs-symbol">:orders</span>])
</code></pre>
<p>to this code:</p>
<pre><code class="hljs css language-ruby">Client.where(<span class="hljs-string">"orders_count = <span class="hljs-subst">#{params[<span class="hljs-symbol">:orders</span>]}</span>"</span>)
</code></pre>
<p>because of argument safety. Putting the variable directly into the conditions string will pass the variable to the database <strong>as-is</strong>. This means that it will be an unescaped variable directly from a user who may have malicious intent. If you do this, you put your entire database at risk because once a user finds out they can exploit your database they can do just about anything to it. Never ever put your arguments directly inside the conditions string.</p>
<p>TIP: For more information on the dangers of SQL injection, see the <a href="security.html#sql-injection">Ruby on Rails Security Guide</a>.</p>
<h4><a class="anchor" aria-hidden="true" id="placeholder-conditions"></a><a href="#placeholder-conditions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Placeholder Conditions</h4>
<p>Similar to the <code>(?)</code> replacement style of params, you can also specify keys in your conditions string along with a corresponding keys/values hash:</p>
<pre><code class="hljs css language-ruby">Client.where(<span class="hljs-string">"created_at &gt;= :start_date AND created_at &lt;= :end_date"</span>,
  {<span class="hljs-symbol">start_date:</span> params[<span class="hljs-symbol">:start_date</span>], <span class="hljs-symbol">end_date:</span> params[<span class="hljs-symbol">:end_date</span>]})
</code></pre>
<p>This makes for clearer readability if you have a large number of variable conditions.</p>
<h3><a class="anchor" aria-hidden="true" id="hash-conditions"></a><a href="#hash-conditions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hash Conditions</h3>
<p>Active Record also allows you to pass in hash conditions which can increase the readability of your conditions syntax. With hash conditions, you pass in a hash with keys of the fields you want qualified and the values of how you want to qualify them:</p>
<p>NOTE: Only equality, range, and subset checking are possible with Hash conditions.</p>
<h4><a class="anchor" aria-hidden="true" id="equality-conditions"></a><a href="#equality-conditions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Equality Conditions</h4>
<pre><code class="hljs css language-ruby">Client.where(<span class="hljs-symbol">locked:</span> <span class="hljs-literal">true</span>)
</code></pre>
<p>This will generate SQL like this:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> clients <span class="hljs-keyword">WHERE</span> (clients.locked = <span class="hljs-number">1</span>)
</code></pre>
<p>The field name can also be a string:</p>
<pre><code class="hljs css language-ruby">Client.where(<span class="hljs-string">'locked'</span> =&gt; <span class="hljs-literal">true</span>)
</code></pre>
<p>In the case of a belongs_to relationship, an association key can be used to specify the model if an Active Record object is used as the value. This method works with polymorphic relationships as well.</p>
<pre><code class="hljs css language-ruby">Article.where(<span class="hljs-symbol">author:</span> author)
Author.joins(<span class="hljs-symbol">:articles</span>).where(<span class="hljs-symbol">articles:</span> { <span class="hljs-symbol">author:</span> author })
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="range-conditions"></a><a href="#range-conditions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Range Conditions</h4>
<pre><code class="hljs css language-ruby">Client.where(<span class="hljs-symbol">created_at:</span> (Time.now.midnight - <span class="hljs-number">1</span>.day)..Time.now.midnight)
</code></pre>
<p>This will find all clients created yesterday by using a <code>BETWEEN</code> SQL statement:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> clients <span class="hljs-keyword">WHERE</span> (clients.created_at <span class="hljs-keyword">BETWEEN</span> <span class="hljs-string">'2008-12-21 00:00:00'</span> <span class="hljs-keyword">AND</span> <span class="hljs-string">'2008-12-22 00:00:00'</span>)
</code></pre>
<p>This demonstrates a shorter syntax for the examples in <a href="#array-conditions">Array Conditions</a></p>
<h4><a class="anchor" aria-hidden="true" id="subset-conditions"></a><a href="#subset-conditions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Subset Conditions</h4>
<p>If you want to find records using the <code>IN</code> expression you can pass an array to the conditions hash:</p>
<pre><code class="hljs css language-ruby">Client.where(<span class="hljs-symbol">orders_count:</span> [<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">5</span>])
</code></pre>
<p>This code will generate SQL like this:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> clients <span class="hljs-keyword">WHERE</span> (clients.orders_count <span class="hljs-keyword">IN</span> (<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">5</span>))
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="not-conditions"></a><a href="#not-conditions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>NOT Conditions</h3>
<p><code>NOT</code> SQL queries can be built by <code>where.not</code>:</p>
<pre><code class="hljs css language-ruby">Client.where.<span class="hljs-keyword">not</span>(<span class="hljs-symbol">locked:</span> <span class="hljs-literal">true</span>)
</code></pre>
<p>In other words, this query can be generated by calling <code>where</code> with no argument, then immediately chain with <code>not</code> passing <code>where</code> conditions.  This will generate SQL like this:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> clients <span class="hljs-keyword">WHERE</span> (clients.locked != <span class="hljs-number">1</span>)
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="or-conditions"></a><a href="#or-conditions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>OR Conditions</h3>
<p><code>OR</code> conditions between two relations can be built by calling <code>or</code> on the first
relation, and passing the second one as an argument.</p>
<pre><code class="hljs css language-ruby">Client.where(<span class="hljs-symbol">locked:</span> <span class="hljs-literal">true</span>).<span class="hljs-keyword">or</span>(Client.where(<span class="hljs-symbol">orders_count:</span> [<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">5</span>]))
</code></pre>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> clients <span class="hljs-keyword">WHERE</span> (clients.locked = <span class="hljs-number">1</span> <span class="hljs-keyword">OR</span> clients.orders_count <span class="hljs-keyword">IN</span> (<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">5</span>))
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="ordering"></a><a href="#ordering" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Ordering</h2>
<p>To retrieve records from the database in a specific order, you can use the <code>order</code> method.</p>
<p>For example, if you're getting a set of records and want to order them in ascending order by the <code>created_at</code> field in your table:</p>
<pre><code class="hljs css language-ruby">Client.order(<span class="hljs-symbol">:created_at</span>)
<span class="hljs-comment"># OR</span>
Client.order(<span class="hljs-string">"created_at"</span>)
</code></pre>
<p>You could specify <code>ASC</code> or <code>DESC</code> as well:</p>
<pre><code class="hljs css language-ruby">Client.order(<span class="hljs-symbol">created_at:</span> <span class="hljs-symbol">:desc</span>)
<span class="hljs-comment"># OR</span>
Client.order(<span class="hljs-symbol">created_at:</span> <span class="hljs-symbol">:asc</span>)
<span class="hljs-comment"># OR</span>
Client.order(<span class="hljs-string">"created_at DESC"</span>)
<span class="hljs-comment"># OR</span>
Client.order(<span class="hljs-string">"created_at ASC"</span>)
</code></pre>
<p>Or ordering by multiple fields:</p>
<pre><code class="hljs css language-ruby">Client.order(<span class="hljs-symbol">orders_count:</span> <span class="hljs-symbol">:asc</span>, <span class="hljs-symbol">created_at:</span> <span class="hljs-symbol">:desc</span>)
<span class="hljs-comment"># OR</span>
Client.order(<span class="hljs-symbol">:orders_count</span>, <span class="hljs-symbol">created_at:</span> <span class="hljs-symbol">:desc</span>)
<span class="hljs-comment"># OR</span>
Client.order(<span class="hljs-string">"orders_count ASC, created_at DESC"</span>)
<span class="hljs-comment"># OR</span>
Client.order(<span class="hljs-string">"orders_count ASC"</span>, <span class="hljs-string">"created_at DESC"</span>)
</code></pre>
<p>If you want to call <code>order</code> multiple times, subsequent orders will be appended to the first:</p>
<pre><code class="hljs css language-ruby">Client.order(<span class="hljs-string">"orders_count ASC"</span>).order(<span class="hljs-string">"created_at DESC"</span>)
<span class="hljs-comment"># SELECT * FROM clients ORDER BY orders_count ASC, created_at DESC</span>
</code></pre>
<p>WARNING: In most database systems, on selecting fields with <code>distinct</code> from a result set using methods like <code>select</code>, <code>pluck</code> and <code>ids</code>; the <code>order</code> method will raise an <code>ActiveRecord::StatementInvalid</code> exception unless the field(s) used in <code>order</code> clause are included in the select list. See the next section for selecting fields from the result set.</p>
<h2><a class="anchor" aria-hidden="true" id="selecting-specific-fields"></a><a href="#selecting-specific-fields" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Selecting Specific Fields</h2>
<p>By default, <code>Model.find</code> selects all the fields from the result set using <code>select *</code>.</p>
<p>To select only a subset of fields from the result set, you can specify the subset via the <code>select</code> method.</p>
<p>For example, to select only <code>viewable_by</code> and <code>locked</code> columns:</p>
<pre><code class="hljs css language-ruby">Client.select(<span class="hljs-symbol">:viewable_by</span>, <span class="hljs-symbol">:locked</span>)
<span class="hljs-comment"># OR</span>
Client.select(<span class="hljs-string">"viewable_by, locked"</span>)
</code></pre>
<p>The SQL query used by this find call will be somewhat like:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> viewable_by, <span class="hljs-keyword">locked</span> <span class="hljs-keyword">FROM</span> clients
</code></pre>
<p>Be careful because this also means you're initializing a model object with only the fields that you've selected. If you attempt to access a field that is not in the initialized record you'll receive:</p>
<pre><code class="hljs css language-bash">ActiveModel::MissingAttributeError: missing attribute: &lt;attribute&gt;
</code></pre>
<p>Where <code>&lt;attribute&gt;</code> is the attribute you asked for. The <code>id</code> method will not raise the <code>ActiveRecord::MissingAttributeError</code>, so just be careful when working with associations because they need the <code>id</code> method to function properly.</p>
<p>If you would like to only grab a single record per unique value in a certain field, you can use <code>distinct</code>:</p>
<pre><code class="hljs css language-ruby">Client.select(<span class="hljs-symbol">:name</span>).distinct
</code></pre>
<p>This would generate SQL like:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> clients
</code></pre>
<p>You can also remove the uniqueness constraint:</p>
<pre><code class="hljs css language-ruby">query = Client.select(<span class="hljs-symbol">:name</span>).distinct
<span class="hljs-comment"># =&gt; Returns unique names</span>

query.distinct(<span class="hljs-literal">false</span>)
<span class="hljs-comment"># =&gt; Returns all names, even if there are duplicates</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="limit-and-offset"></a><a href="#limit-and-offset" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Limit and Offset</h2>
<p>To apply <code>LIMIT</code> to the SQL fired by the <code>Model.find</code>, you can specify the <code>LIMIT</code> using <code>limit</code> and <code>offset</code> methods on the relation.</p>
<p>You can use <code>limit</code> to specify the number of records to be retrieved, and use <code>offset</code> to specify the number of records to skip before starting to return the records. For example</p>
<pre><code class="hljs css language-ruby">Client.limit(<span class="hljs-number">5</span>)
</code></pre>
<p>will return a maximum of 5 clients and because it specifies no offset it will return the first 5 in the table. The SQL it executes looks like this:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> clients <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">5</span>
</code></pre>
<p>Adding <code>offset</code> to that</p>
<pre><code class="hljs css language-ruby">Client.limit(<span class="hljs-number">5</span>).offset(<span class="hljs-number">30</span>)
</code></pre>
<p>will return instead a maximum of 5 clients beginning with the 31st. The SQL looks like:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> clients <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">5</span> <span class="hljs-keyword">OFFSET</span> <span class="hljs-number">30</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="group"></a><a href="#group" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Group</h2>
<p>To apply a <code>GROUP BY</code> clause to the SQL fired by the finder, you can use the <code>group</code> method.</p>
<p>For example, if you want to find a collection of the dates on which orders were created:</p>
<pre><code class="hljs css language-ruby">Order.select(<span class="hljs-string">"date(created_at) as ordered_date, sum(price) as total_price"</span>).group(<span class="hljs-string">"date(created_at)"</span>)
</code></pre>
<p>And this will give you a single <code>Order</code> object for each date where there are orders in the database.</p>
<p>The SQL that would be executed would be something like this:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">date</span>(created_at) <span class="hljs-keyword">as</span> ordered_date, <span class="hljs-keyword">sum</span>(price) <span class="hljs-keyword">as</span> total_price
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">date</span>(created_at)
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="total-of-grouped-items"></a><a href="#total-of-grouped-items" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Total of grouped items</h3>
<p>To get the total of grouped items on a single query, call <code>count</code> after the <code>group</code>.</p>
<pre><code class="hljs css language-ruby">Order.group(<span class="hljs-symbol">:status</span>).count
<span class="hljs-comment"># =&gt; { 'awaiting_approval' =&gt; 7, 'paid' =&gt; 12 }</span>
</code></pre>
<p>The SQL that would be executed would be something like this:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span> (*) <span class="hljs-keyword">AS</span> count_all, <span class="hljs-keyword">status</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">status</span>
<span class="hljs-keyword">FROM</span> <span class="hljs-string">"orders"</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">status</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="having"></a><a href="#having" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Having</h2>
<p>SQL uses the <code>HAVING</code> clause to specify conditions on the <code>GROUP BY</code> fields. You can add the <code>HAVING</code> clause to the SQL fired by the <code>Model.find</code> by adding the <code>having</code> method to the find.</p>
<p>For example:</p>
<pre><code class="hljs css language-ruby">Order.select(<span class="hljs-string">"date(created_at) as ordered_date, sum(price) as total_price"</span>).
  group(<span class="hljs-string">"date(created_at)"</span>).having(<span class="hljs-string">"sum(price) &gt; ?"</span>, <span class="hljs-number">100</span>)
</code></pre>
<p>The SQL that would be executed would be something like this:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">date</span>(created_at) <span class="hljs-keyword">as</span> ordered_date, <span class="hljs-keyword">sum</span>(price) <span class="hljs-keyword">as</span> total_price
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">date</span>(created_at)
<span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">sum</span>(price) &gt; <span class="hljs-number">100</span>
</code></pre>
<p>This returns the date and total price for each order object, grouped by the day they were ordered and where the price is more than $100.</p>
<h2><a class="anchor" aria-hidden="true" id="overriding-conditions"></a><a href="#overriding-conditions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Overriding Conditions</h2>
<h3><a class="anchor" aria-hidden="true" id="unscope"></a><a href="#unscope" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>unscope</code></h3>
<p>You can specify certain conditions to be removed using the <code>unscope</code> method. For example:</p>
<pre><code class="hljs css language-ruby">Article.where(<span class="hljs-string">'id &gt; 10'</span>).limit(<span class="hljs-number">20</span>).order(<span class="hljs-string">'id asc'</span>).unscope(<span class="hljs-symbol">:order</span>)
</code></pre>
<p>The SQL that would be executed:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> articles <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> &gt; <span class="hljs-number">10</span> <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>

<span class="hljs-comment"># Original query without `unscope`</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> articles <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> &gt; <span class="hljs-number">10</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">id</span> <span class="hljs-keyword">asc</span> <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>

</code></pre>
<p>You can also unscope specific <code>where</code> clauses. For example:</p>
<pre><code class="hljs css language-ruby">Article.where(<span class="hljs-symbol">id:</span> <span class="hljs-number">10</span>, <span class="hljs-symbol">trashed:</span> <span class="hljs-literal">false</span>).unscope(<span class="hljs-symbol">where:</span> <span class="hljs-symbol">:id</span>)
<span class="hljs-comment"># SELECT "articles".* FROM "articles" WHERE trashed = 0</span>
</code></pre>
<p>A relation which has used <code>unscope</code> will affect any relation into which it is merged:</p>
<pre><code class="hljs css language-ruby">Article.order(<span class="hljs-string">'id asc'</span>).merge(Article.unscope(<span class="hljs-symbol">:order</span>))
<span class="hljs-comment"># SELECT "articles".* FROM "articles"</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="only"></a><a href="#only" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>only</code></h3>
<p>You can also override conditions using the <code>only</code> method. For example:</p>
<pre><code class="hljs css language-ruby">Article.where(<span class="hljs-string">'id &gt; 10'</span>).limit(<span class="hljs-number">20</span>).order(<span class="hljs-string">'id desc'</span>).only(<span class="hljs-symbol">:order</span>, <span class="hljs-symbol">:where</span>)
</code></pre>
<p>The SQL that would be executed:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> articles <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> &gt; <span class="hljs-number">10</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">id</span> <span class="hljs-keyword">DESC</span>

<span class="hljs-comment"># Original query without `only`</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> articles <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> &gt; <span class="hljs-number">10</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">id</span> <span class="hljs-keyword">DESC</span> <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>

</code></pre>
<h3><a class="anchor" aria-hidden="true" id="reselect"></a><a href="#reselect" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>reselect</code></h3>
<p>The <code>reselect</code> method overrides an existing select statement. For example:</p>
<pre><code class="hljs css language-ruby">Post.select(<span class="hljs-symbol">:title</span>, <span class="hljs-symbol">:body</span>).reselect(<span class="hljs-symbol">:created_at</span>)
</code></pre>
<p>The SQL that would be executed:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-string">`posts`</span>.<span class="hljs-string">`created_at`</span> <span class="hljs-keyword">FROM</span> <span class="hljs-string">`posts`</span>
</code></pre>
<p>In case the <code>reselect</code> clause is not used,</p>
<pre><code class="hljs css language-ruby">Post.select(<span class="hljs-symbol">:title</span>, <span class="hljs-symbol">:body</span>).select(<span class="hljs-symbol">:created_at</span>)
</code></pre>
<p>the SQL executed would be:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-string">`posts`</span>.<span class="hljs-string">`title`</span>, <span class="hljs-string">`posts`</span>.<span class="hljs-string">`body`</span>, <span class="hljs-string">`posts`</span>.<span class="hljs-string">`created_at`</span> <span class="hljs-keyword">FROM</span> <span class="hljs-string">`posts`</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="reorder"></a><a href="#reorder" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>reorder</code></h3>
<p>The <code>reorder</code> method overrides the default scope order. For example:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Article</span> &lt; ApplicationRecord</span>
  has_many <span class="hljs-symbol">:comments</span>, -&gt; { order(<span class="hljs-string">'posted_at DESC'</span>) }
<span class="hljs-keyword">end</span>

Article.find(<span class="hljs-number">10</span>).comments.reorder(<span class="hljs-string">'name'</span>)
</code></pre>
<p>The SQL that would be executed:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> articles <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">10</span> <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> comments <span class="hljs-keyword">WHERE</span> article_id = <span class="hljs-number">10</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">name</span>
</code></pre>
<p>In the case where the <code>reorder</code> clause is not used, the SQL executed would be:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> articles <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">10</span> <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> comments <span class="hljs-keyword">WHERE</span> article_id = <span class="hljs-number">10</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> posted_at <span class="hljs-keyword">DESC</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="reverse_order"></a><a href="#reverse_order" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>reverse_order</code></h3>
<p>The <code>reverse_order</code> method reverses the ordering clause if specified.</p>
<pre><code class="hljs css language-ruby">Client.where(<span class="hljs-string">"orders_count &gt; 10"</span>).order(<span class="hljs-symbol">:name</span>).reverse_order
</code></pre>
<p>The SQL that would be executed:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> clients <span class="hljs-keyword">WHERE</span> orders_count &gt; <span class="hljs-number">10</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">DESC</span>
</code></pre>
<p>If no ordering clause is specified in the query, the <code>reverse_order</code> orders by the primary key in reverse order.</p>
<pre><code class="hljs css language-ruby">Client.where(<span class="hljs-string">"orders_count &gt; 10"</span>).reverse_order
</code></pre>
<p>The SQL that would be executed:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> clients <span class="hljs-keyword">WHERE</span> orders_count &gt; <span class="hljs-number">10</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> clients.id <span class="hljs-keyword">DESC</span>
</code></pre>
<p>This method accepts <strong>no</strong> arguments.</p>
<h3><a class="anchor" aria-hidden="true" id="rewhere"></a><a href="#rewhere" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>rewhere</code></h3>
<p>The <code>rewhere</code> method overrides an existing, named where condition. For example:</p>
<pre><code class="hljs css language-ruby">Article.where(<span class="hljs-symbol">trashed:</span> <span class="hljs-literal">true</span>).rewhere(<span class="hljs-symbol">trashed:</span> <span class="hljs-literal">false</span>)
</code></pre>
<p>The SQL that would be executed:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> articles <span class="hljs-keyword">WHERE</span> <span class="hljs-string">`trashed`</span> = <span class="hljs-number">0</span>
</code></pre>
<p>In case the <code>rewhere</code> clause is not used,</p>
<pre><code class="hljs css language-ruby">Article.where(<span class="hljs-symbol">trashed:</span> <span class="hljs-literal">true</span>).where(<span class="hljs-symbol">trashed:</span> <span class="hljs-literal">false</span>)
</code></pre>
<p>the SQL executed would be:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> articles <span class="hljs-keyword">WHERE</span> <span class="hljs-string">`trashed`</span> = <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> <span class="hljs-string">`trashed`</span> = <span class="hljs-number">0</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="null-relation"></a><a href="#null-relation" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Null Relation</h2>
<p>The <code>none</code> method returns a chainable relation with no records. Any subsequent conditions chained to the returned relation will continue generating empty relations. This is useful in scenarios where you need a chainable response to a method or a scope that could return zero results.</p>
<pre><code class="hljs css language-ruby">Article.none <span class="hljs-comment"># returns an empty Relation and fires no queries.</span>
</code></pre>
<pre><code class="hljs css language-ruby"><span class="hljs-comment"># The visible_articles method below is expected to return a Relation.</span>
@articles = current_user.visible_articles.where(<span class="hljs-symbol">name:</span> params[<span class="hljs-symbol">:name</span>])

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">visible_articles</span></span>
  <span class="hljs-keyword">case</span> role
  <span class="hljs-keyword">when</span> <span class="hljs-string">'Country Manager'</span>
    Article.where(<span class="hljs-symbol">country:</span> country)
  <span class="hljs-keyword">when</span> <span class="hljs-string">'Reviewer'</span>
    Article.published
  <span class="hljs-keyword">when</span> <span class="hljs-string">'Bad User'</span>
    Article.none <span class="hljs-comment"># =&gt; returning [] or nil breaks the caller code in this case</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="readonly-objects"></a><a href="#readonly-objects" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Readonly Objects</h2>
<p>Active Record provides the <code>readonly</code> method on a relation to explicitly disallow modification of any of the returned objects. Any attempt to alter a readonly record will not succeed, raising an <code>ActiveRecord::ReadOnlyRecord</code> exception.</p>
<pre><code class="hljs css language-ruby">client = Client.readonly.first
client.visits += <span class="hljs-number">1</span>
client.save
</code></pre>
<p>As <code>client</code> is explicitly set to be a readonly object, the above code will raise an <code>ActiveRecord::ReadOnlyRecord</code> exception when calling <code>client.save</code> with an updated value of <em>visits</em>.</p>
<h2><a class="anchor" aria-hidden="true" id="locking-records-for-update"></a><a href="#locking-records-for-update" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Locking Records for Update</h2>
<p>Locking is helpful for preventing race conditions when updating records in the database and ensuring atomic updates.</p>
<p>Active Record provides two locking mechanisms:</p>
<ul>
<li>Optimistic Locking</li>
<li>Pessimistic Locking</li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="optimistic-locking"></a><a href="#optimistic-locking" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Optimistic Locking</h3>
<p>Optimistic locking allows multiple users to access the same record for edits, and assumes a minimum of conflicts with the data. It does this by checking whether another process has made changes to a record since it was opened. An <code>ActiveRecord::StaleObjectError</code> exception is thrown if that has occurred and the update is ignored.</p>
<p><strong>Optimistic locking column</strong></p>
<p>In order to use optimistic locking, the table needs to have a column called <code>lock_version</code> of type integer. Each time the record is updated, Active Record increments the <code>lock_version</code> column. If an update request is made with a lower value in the <code>lock_version</code> field than is currently in the <code>lock_version</code> column in the database, the update request will fail with an <code>ActiveRecord::StaleObjectError</code>. Example:</p>
<pre><code class="hljs css language-ruby">c1 = Client.find(<span class="hljs-number">1</span>)
c2 = Client.find(<span class="hljs-number">1</span>)

c1.first_name = <span class="hljs-string">"Michael"</span>
c1.save

c2.name = <span class="hljs-string">"should fail"</span>
c2.save <span class="hljs-comment"># Raises an ActiveRecord::StaleObjectError</span>
</code></pre>
<p>You're then responsible for dealing with the conflict by rescuing the exception and either rolling back, merging, or otherwise apply the business logic needed to resolve the conflict.</p>
<p>This behavior can be turned off by setting <code>ActiveRecord::Base.lock_optimistically = false</code>.</p>
<p>To override the name of the <code>lock_version</code> column, <code>ActiveRecord::Base</code> provides a class attribute called <code>locking_column</code>:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Client</span> &lt; ApplicationRecord</span>
  <span class="hljs-keyword">self</span>.locking_column = <span class="hljs-symbol">:lock_client_column</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="pessimistic-locking"></a><a href="#pessimistic-locking" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Pessimistic Locking</h3>
<p>Pessimistic locking uses a locking mechanism provided by the underlying database. Using <code>lock</code> when building a relation obtains an exclusive lock on the selected rows. Relations using <code>lock</code> are usually wrapped inside a transaction for preventing deadlock conditions.</p>
<p>For example:</p>
<pre><code class="hljs css language-ruby">Item.transaction <span class="hljs-keyword">do</span>
  i = Item.lock.first
  i.name = <span class="hljs-string">'Jones'</span>
  i.save!
<span class="hljs-keyword">end</span>
</code></pre>
<p>The above session produces the following SQL for a MySQL backend:</p>
<pre><code class="hljs css language-sql">SQL (0.2ms)   <span class="hljs-keyword">BEGIN</span>
Item <span class="hljs-keyword">Load</span> (<span class="hljs-number">0.3</span>ms)   <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> <span class="hljs-string">`items`</span> <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>
Item <span class="hljs-keyword">Update</span> (<span class="hljs-number">0.4</span>ms)   <span class="hljs-keyword">UPDATE</span> <span class="hljs-string">`items`</span> <span class="hljs-keyword">SET</span> <span class="hljs-string">`updated_at`</span> = <span class="hljs-string">'2009-02-07 18:05:56'</span>, <span class="hljs-string">`name`</span> = <span class="hljs-string">'Jones'</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-string">`id`</span> = <span class="hljs-number">1</span>
<span class="hljs-keyword">SQL</span> (<span class="hljs-number">0.8</span>ms)   <span class="hljs-keyword">COMMIT</span>
</code></pre>
<p>You can also pass raw SQL to the <code>lock</code> method for allowing different types of locks. For example, MySQL has an expression called <code>LOCK IN SHARE MODE</code> where you can lock a record but still allow other queries to read it. To specify this expression just pass it in as the lock option:</p>
<pre><code class="hljs css language-ruby">Item.transaction <span class="hljs-keyword">do</span>
  i = Item.lock(<span class="hljs-string">"LOCK IN SHARE MODE"</span>).find(<span class="hljs-number">1</span>)
  i.increment!(<span class="hljs-symbol">:views</span>)
<span class="hljs-keyword">end</span>
</code></pre>
<p>If you already have an instance of your model, you can start a transaction and acquire the lock in one go using the following code:</p>
<pre><code class="hljs css language-ruby">item = Item.first
item.with_lock <span class="hljs-keyword">do</span>
  <span class="hljs-comment"># This block is called within a transaction,</span>
  <span class="hljs-comment"># item is already locked.</span>
  item.increment!(<span class="hljs-symbol">:views</span>)
<span class="hljs-keyword">end</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="joining-tables"></a><a href="#joining-tables" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Joining Tables</h2>
<p>Active Record provides two finder methods for specifying <code>JOIN</code> clauses on the
resulting SQL: <code>joins</code> and <code>left_outer_joins</code>.
While <code>joins</code> should be used for <code>INNER JOIN</code> or custom queries,
<code>left_outer_joins</code> is used for queries using <code>LEFT OUTER JOIN</code>.</p>
<h3><a class="anchor" aria-hidden="true" id="joins"></a><a href="#joins" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>joins</code></h3>
<p>There are multiple ways to use the <code>joins</code> method.</p>
<h4><a class="anchor" aria-hidden="true" id="using-a-string-sql-fragment"></a><a href="#using-a-string-sql-fragment" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using a String SQL Fragment</h4>
<p>You can just supply the raw SQL specifying the <code>JOIN</code> clause to <code>joins</code>:</p>
<pre><code class="hljs css language-ruby">Author.joins(<span class="hljs-string">"INNER JOIN posts ON posts.author_id = authors.id AND posts.published = 't'"</span>)
</code></pre>
<p>This will result in the following SQL:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> authors.* <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">authors</span> <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> posts <span class="hljs-keyword">ON</span> posts.author_id = authors.id <span class="hljs-keyword">AND</span> posts.published = <span class="hljs-string">'t'</span>
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="using-array-hash-of-named-associations"></a><a href="#using-array-hash-of-named-associations" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using Array/Hash of Named Associations</h4>
<p>Active Record lets you use the names of the <a href="/rails-setup/docs/rails/active-record-associations">associations</a> defined on the model as a shortcut for specifying <code>JOIN</code> clauses for those associations when using the <code>joins</code> method.</p>
<p>For example, consider the following <code>Category</code>, <code>Article</code>, <code>Comment</code>, <code>Guest</code> and <code>Tag</code> models:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Category</span> &lt; ApplicationRecord</span>
  has_many <span class="hljs-symbol">:articles</span>
<span class="hljs-keyword">end</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Article</span> &lt; ApplicationRecord</span>
  belongs_to <span class="hljs-symbol">:category</span>
  has_many <span class="hljs-symbol">:comments</span>
  has_many <span class="hljs-symbol">:tags</span>
<span class="hljs-keyword">end</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Comment</span> &lt; ApplicationRecord</span>
  belongs_to <span class="hljs-symbol">:article</span>
  has_one <span class="hljs-symbol">:guest</span>
<span class="hljs-keyword">end</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Guest</span> &lt; ApplicationRecord</span>
  belongs_to <span class="hljs-symbol">:comment</span>
<span class="hljs-keyword">end</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Tag</span> &lt; ApplicationRecord</span>
  belongs_to <span class="hljs-symbol">:article</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>Now all of the following will produce the expected join queries using <code>INNER JOIN</code>:</p>
<h5><a class="anchor" aria-hidden="true" id="joining-a-single-association"></a><a href="#joining-a-single-association" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Joining a Single Association</h5>
<pre><code class="hljs css language-ruby">Category.joins(<span class="hljs-symbol">:articles</span>)
</code></pre>
<p>This produces:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> categories.* <span class="hljs-keyword">FROM</span> categories
  <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> articles <span class="hljs-keyword">ON</span> articles.category_id = categories.id
</code></pre>
<p>Or, in English: &quot;return a Category object for all categories with articles&quot;. Note that you will see duplicate categories if more than one article has the same category. If you want unique categories, you can use <code>Category.joins(:articles).distinct</code>.</p>
<h4><a class="anchor" aria-hidden="true" id="joining-multiple-associations"></a><a href="#joining-multiple-associations" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Joining Multiple Associations</h4>
<pre><code class="hljs css language-ruby">Article.joins(<span class="hljs-symbol">:category</span>, <span class="hljs-symbol">:comments</span>)
</code></pre>
<p>This produces:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> articles.* <span class="hljs-keyword">FROM</span> articles
  <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> categories <span class="hljs-keyword">ON</span> categories.id = articles.category_id
  <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> comments <span class="hljs-keyword">ON</span> comments.article_id = articles.id
</code></pre>
<p>Or, in English: &quot;return all articles that have a category and at least one comment&quot;. Note again that articles with multiple comments will show up multiple times.</p>
<h5><a class="anchor" aria-hidden="true" id="joining-nested-associations-single-level"></a><a href="#joining-nested-associations-single-level" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Joining Nested Associations (Single Level)</h5>
<pre><code class="hljs css language-ruby">Article.joins(<span class="hljs-symbol">comments:</span> <span class="hljs-symbol">:guest</span>)
</code></pre>
<p>This produces:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> articles.* <span class="hljs-keyword">FROM</span> articles
  <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> comments <span class="hljs-keyword">ON</span> comments.article_id = articles.id
  <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> guests <span class="hljs-keyword">ON</span> guests.comment_id = comments.id
</code></pre>
<p>Or, in English: &quot;return all articles that have a comment made by a guest.&quot;</p>
<h5><a class="anchor" aria-hidden="true" id="joining-nested-associations-multiple-level"></a><a href="#joining-nested-associations-multiple-level" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Joining Nested Associations (Multiple Level)</h5>
<pre><code class="hljs css language-ruby">Category.joins(<span class="hljs-symbol">articles:</span> [{ <span class="hljs-symbol">comments:</span> <span class="hljs-symbol">:guest</span> }, <span class="hljs-symbol">:tags</span>])
</code></pre>
<p>This produces:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> categories.* <span class="hljs-keyword">FROM</span> categories
  <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> articles <span class="hljs-keyword">ON</span> articles.category_id = categories.id
  <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> comments <span class="hljs-keyword">ON</span> comments.article_id = articles.id
  <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> guests <span class="hljs-keyword">ON</span> guests.comment_id = comments.id
  <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> tags <span class="hljs-keyword">ON</span> tags.article_id = articles.id
</code></pre>
<p>Or, in English: &quot;return all categories that have articles, where those articles have a comment made by a guest, and where those articles also have a tag.&quot;</p>
<h4><a class="anchor" aria-hidden="true" id="specifying-conditions-on-the-joined-tables"></a><a href="#specifying-conditions-on-the-joined-tables" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Specifying Conditions on the Joined Tables</h4>
<p>You can specify conditions on the joined tables using the regular <a href="#array-conditions">Array</a> and <a href="#pure-string-conditions">String</a> conditions. <a href="#hash-conditions">Hash conditions</a> provide a special syntax for specifying conditions for the joined tables:</p>
<pre><code class="hljs css language-ruby">time_range = (Time.now.midnight - <span class="hljs-number">1</span>.day)..Time.now.midnight
Client.joins(<span class="hljs-symbol">:orders</span>).where(<span class="hljs-string">'orders.created_at'</span> =&gt; time_range)
</code></pre>
<p>An alternative and cleaner syntax is to nest the hash conditions:</p>
<pre><code class="hljs css language-ruby">time_range = (Time.now.midnight - <span class="hljs-number">1</span>.day)..Time.now.midnight
Client.joins(<span class="hljs-symbol">:orders</span>).where(<span class="hljs-symbol">orders:</span> { <span class="hljs-symbol">created_at:</span> time_range })
</code></pre>
<p>This will find all clients who have orders that were created yesterday, again using a <code>BETWEEN</code> SQL expression.</p>
<h3><a class="anchor" aria-hidden="true" id="left_outer_joins"></a><a href="#left_outer_joins" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>left_outer_joins</code></h3>
<p>If you want to select a set of records whether or not they have associated
records you can use the <code>left_outer_joins</code> method.</p>
<pre><code class="hljs css language-ruby">Author.left_outer_joins(<span class="hljs-symbol">:posts</span>).distinct.select(<span class="hljs-string">'authors.*, COUNT(posts.*) AS posts_count'</span>).group(<span class="hljs-string">'authors.id'</span>)
</code></pre>
<p>Which produces:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> authors.*, <span class="hljs-keyword">COUNT</span>(posts.*) <span class="hljs-keyword">AS</span> posts_count <span class="hljs-keyword">FROM</span> <span class="hljs-string">"authors"</span>
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> posts <span class="hljs-keyword">ON</span> posts.author_id = authors.id <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> authors.id
</code></pre>
<p>Which means: &quot;return all authors with their count of posts, whether or not they
have any posts at all&quot;</p>
<h2><a class="anchor" aria-hidden="true" id="eager-loading-associations"></a><a href="#eager-loading-associations" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Eager Loading Associations</h2>
<p>Eager loading is the mechanism for loading the associated records of the objects returned by <code>Model.find</code> using as few queries as possible.</p>
<p><strong>N + 1 queries problem</strong></p>
<p>Consider the following code, which finds 10 clients and prints their postcodes:</p>
<pre><code class="hljs css language-ruby">clients = Client.limit(<span class="hljs-number">10</span>)

clients.each <span class="hljs-keyword">do</span> <span class="hljs-params">|client|</span>
  puts client.address.postcode
<span class="hljs-keyword">end</span>
</code></pre>
<p>This code looks fine at the first sight. But the problem lies within the total number of queries executed. The above code executes 1 (to find 10 clients) + 10 (one per each client to load the address) = <strong>11</strong> queries in total.</p>
<p><strong>Solution to N + 1 queries problem</strong></p>
<p>Active Record lets you specify in advance all the associations that are going to be loaded. This is possible by specifying the <code>includes</code> method of the <code>Model.find</code> call. With <code>includes</code>, Active Record ensures that all of the specified associations are loaded using the minimum possible number of queries.</p>
<p>Revisiting the above case, we could rewrite <code>Client.limit(10)</code> to eager load addresses:</p>
<pre><code class="hljs css language-ruby">clients = Client.includes(<span class="hljs-symbol">:address</span>).limit(<span class="hljs-number">10</span>)

clients.each <span class="hljs-keyword">do</span> <span class="hljs-params">|client|</span>
  puts client.address.postcode
<span class="hljs-keyword">end</span>
</code></pre>
<p>The above code will execute just <strong>2</strong> queries, as opposed to <strong>11</strong> queries in the previous case:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> clients <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>
<span class="hljs-keyword">SELECT</span> addresses.* <span class="hljs-keyword">FROM</span> addresses
  <span class="hljs-keyword">WHERE</span> (addresses.client_id <span class="hljs-keyword">IN</span> (<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>))
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="eager-loading-multiple-associations"></a><a href="#eager-loading-multiple-associations" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Eager Loading Multiple Associations</h3>
<p>Active Record lets you eager load any number of associations with a single <code>Model.find</code> call by using an array, hash, or a nested hash of array/hash with the <code>includes</code> method.</p>
<h4><a class="anchor" aria-hidden="true" id="array-of-multiple-associations"></a><a href="#array-of-multiple-associations" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Array of Multiple Associations</h4>
<pre><code class="hljs css language-ruby">Article.includes(<span class="hljs-symbol">:category</span>, <span class="hljs-symbol">:comments</span>)
</code></pre>
<p>This loads all the articles and the associated category and comments for each article.</p>
<h4><a class="anchor" aria-hidden="true" id="nested-associations-hash"></a><a href="#nested-associations-hash" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Nested Associations Hash</h4>
<pre><code class="hljs css language-ruby">Category.includes(<span class="hljs-symbol">articles:</span> [{ <span class="hljs-symbol">comments:</span> <span class="hljs-symbol">:guest</span> }, <span class="hljs-symbol">:tags</span>]).find(<span class="hljs-number">1</span>)
</code></pre>
<p>This will find the category with id 1 and eager load all of the associated articles, the associated articles' tags and comments, and every comment's guest association.</p>
<h3><a class="anchor" aria-hidden="true" id="specifying-conditions-on-eager-loaded-associations"></a><a href="#specifying-conditions-on-eager-loaded-associations" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Specifying Conditions on Eager Loaded Associations</h3>
<p>Even though Active Record lets you specify conditions on the eager loaded associations just like <code>joins</code>, the recommended way is to use <a href="#joining-tables">joins</a> instead.</p>
<p>However if you must do this, you may use <code>where</code> as you would normally.</p>
<pre><code class="hljs css language-ruby">Article.includes(<span class="hljs-symbol">:comments</span>).where(<span class="hljs-symbol">comments:</span> { <span class="hljs-symbol">visible:</span> <span class="hljs-literal">true</span> })
</code></pre>
<p>This would generate a query which contains a <code>LEFT OUTER JOIN</code> whereas the
<code>joins</code> method would generate one using the <code>INNER JOIN</code> function instead.</p>
<pre><code class="hljs css language-ruby">  SELECT <span class="hljs-string">"articles"</span>.<span class="hljs-string">"id"</span> AS t0_r<span class="hljs-number">0</span>, ... <span class="hljs-string">"comments"</span>.<span class="hljs-string">"updated_at"</span> AS t1_r5 FROM <span class="hljs-string">"articles"</span> LEFT OUTER JOIN <span class="hljs-string">"comments"</span> ON <span class="hljs-string">"comments"</span>.<span class="hljs-string">"article_id"</span> = <span class="hljs-string">"articles"</span>.<span class="hljs-string">"id"</span> WHERE (comments.visible = <span class="hljs-number">1</span>)
</code></pre>
<p>If there was no <code>where</code> condition, this would generate the normal set of two queries.</p>
<p>NOTE: Using <code>where</code> like this will only work when you pass it a Hash. For
SQL-fragments you need to use <code>references</code> to force joined tables:</p>
<pre><code class="hljs css language-ruby">Article.includes(<span class="hljs-symbol">:comments</span>).where(<span class="hljs-string">"comments.visible = true"</span>).references(<span class="hljs-symbol">:comments</span>)
</code></pre>
<p>If, in the case of this <code>includes</code> query, there were no comments for any
articles, all the articles would still be loaded. By using <code>joins</code> (an INNER
JOIN), the join conditions <strong>must</strong> match, otherwise no records will be
returned.</p>
<p>NOTE: If an association is eager loaded as part of a join, any fields from a custom select clause will not be present on the loaded models.
This is because it is ambiguous whether they should appear on the parent record, or the child.</p>
<h2><a class="anchor" aria-hidden="true" id="scopes"></a><a href="#scopes" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Scopes</h2>
<p>Scoping allows you to specify commonly-used queries which can be referenced as method calls on the association objects or models. With these scopes, you can use every method previously covered such as <code>where</code>, <code>joins</code> and <code>includes</code>. All scope bodies should return an <code>ActiveRecord::Relation</code> or <code>nil</code> to allow for further methods (such as other scopes) to be called on it.</p>
<p>To define a simple scope, we use the <code>scope</code> method inside the class, passing the query that we'd like to run when this scope is called:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Article</span> &lt; ApplicationRecord</span>
  scope <span class="hljs-symbol">:published</span>, -&gt; { where(<span class="hljs-symbol">published:</span> <span class="hljs-literal">true</span>) }
<span class="hljs-keyword">end</span>
</code></pre>
<p>Scopes are also chainable within scopes:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Article</span> &lt; ApplicationRecord</span>
  scope <span class="hljs-symbol">:published</span>,               -&gt; { where(<span class="hljs-symbol">published:</span> <span class="hljs-literal">true</span>) }
  scope <span class="hljs-symbol">:published_and_commented</span>, -&gt; { published.where(<span class="hljs-string">"comments_count &gt; 0"</span>) }
<span class="hljs-keyword">end</span>
</code></pre>
<p>To call this <code>published</code> scope we can call it on either the class:</p>
<pre><code class="hljs css language-ruby">Article.published <span class="hljs-comment"># =&gt; [published articles]</span>
</code></pre>
<p>Or on an association consisting of <code>Article</code> objects:</p>
<pre><code class="hljs css language-ruby">category = Category.first
category.articles.published <span class="hljs-comment"># =&gt; [published articles belonging to this category]</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="passing-in-arguments"></a><a href="#passing-in-arguments" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Passing in arguments</h3>
<p>Your scope can take arguments:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Article</span> &lt; ApplicationRecord</span>
  scope <span class="hljs-symbol">:created_before</span>, -&gt;(time) { where(<span class="hljs-string">"created_at &lt; ?"</span>, time) }
<span class="hljs-keyword">end</span>
</code></pre>
<p>Call the scope as if it were a class method:</p>
<pre><code class="hljs css language-ruby">Article.created_before(Time.zone.now)
</code></pre>
<p>However, this is just duplicating the functionality that would be provided to you by a class method.</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Article</span> &lt; ApplicationRecord</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">created_before</span><span class="hljs-params">(time)</span></span>
    where(<span class="hljs-string">"created_at &lt; ?"</span>, time)
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>Using a class method is the preferred way to accept arguments for scopes. These methods will still be accessible on the association objects:</p>
<pre><code class="hljs css language-ruby">category.articles.created_before(time)
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="using-conditionals"></a><a href="#using-conditionals" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using conditionals</h3>
<p>Your scope can utilize conditionals:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Article</span> &lt; ApplicationRecord</span>
  scope <span class="hljs-symbol">:created_before</span>, -&gt;(time) { where(<span class="hljs-string">"created_at &lt; ?"</span>, time) <span class="hljs-keyword">if</span> time.present? }
<span class="hljs-keyword">end</span>
</code></pre>
<p>Like the other examples, this will behave similarly to a class method.</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Article</span> &lt; ApplicationRecord</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">created_before</span><span class="hljs-params">(time)</span></span>
    where(<span class="hljs-string">"created_at &lt; ?"</span>, time) <span class="hljs-keyword">if</span> time.present?
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>However, there is one important caveat: A scope will always return an <code>ActiveRecord::Relation</code> object, even if the conditional evaluates to <code>false</code>, whereas a class method, will return <code>nil</code>. This can cause <code>NoMethodError</code> when chaining class methods with conditionals, if any of the conditionals return <code>false</code>.</p>
<h3><a class="anchor" aria-hidden="true" id="applying-a-default-scope"></a><a href="#applying-a-default-scope" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Applying a default scope</h3>
<p>If we wish for a scope to be applied across all queries to the model we can use the
<code>default_scope</code> method within the model itself.</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Client</span> &lt; ApplicationRecord</span>
  default_scope { where(<span class="hljs-string">"removed_at IS NULL"</span>) }
<span class="hljs-keyword">end</span>
</code></pre>
<p>When queries are executed on this model, the SQL query will now look something like
this:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> clients <span class="hljs-keyword">WHERE</span> removed_at <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>
</code></pre>
<p>If you need to do more complex things with a default scope, you can alternatively
define it as a class method:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Client</span> &lt; ApplicationRecord</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">default_scope</span></span>
    <span class="hljs-comment"># Should return an ActiveRecord::Relation.</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>NOTE: The <code>default_scope</code> is also applied while creating/building a record
when the scope arguments are given as a <code>Hash</code>. It is not applied while
updating a record. E.g.:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Client</span> &lt; ApplicationRecord</span>
  default_scope { where(<span class="hljs-symbol">active:</span> <span class="hljs-literal">true</span>) }
<span class="hljs-keyword">end</span>

Client.new          <span class="hljs-comment"># =&gt; #&lt;Client id: nil, active: true&gt;</span>
Client.unscoped.new <span class="hljs-comment"># =&gt; #&lt;Client id: nil, active: nil&gt;</span>
</code></pre>
<p>Be aware that, when given in the <code>Array</code> format, <code>default_scope</code> query arguments
cannot be converted to a <code>Hash</code> for default attribute assignment. E.g.:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Client</span> &lt; ApplicationRecord</span>
  default_scope { where(<span class="hljs-string">"active = ?"</span>, <span class="hljs-literal">true</span>) }
<span class="hljs-keyword">end</span>

Client.new <span class="hljs-comment"># =&gt; #&lt;Client id: nil, active: nil&gt;</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="merging-of-scopes"></a><a href="#merging-of-scopes" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Merging of scopes</h3>
<p>Just like <code>where</code> clauses scopes are merged using <code>AND</code> conditions.</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> &lt; ApplicationRecord</span>
  scope <span class="hljs-symbol">:active</span>, -&gt; { where <span class="hljs-symbol">state:</span> <span class="hljs-string">'active'</span> }
  scope <span class="hljs-symbol">:inactive</span>, -&gt; { where <span class="hljs-symbol">state:</span> <span class="hljs-string">'inactive'</span> }
<span class="hljs-keyword">end</span>

User.active.inactive
<span class="hljs-comment"># SELECT "users".* FROM "users" WHERE "users"."state" = 'active' AND "users"."state" = 'inactive'</span>
</code></pre>
<p>We can mix and match <code>scope</code> and <code>where</code> conditions and the final sql
will have all conditions joined with <code>AND</code>.</p>
<pre><code class="hljs css language-ruby">User.active.where(<span class="hljs-symbol">state:</span> <span class="hljs-string">'finished'</span>)
<span class="hljs-comment"># SELECT "users".* FROM "users" WHERE "users"."state" = 'active' AND "users"."state" = 'finished'</span>
</code></pre>
<p>If we do want the last <code>where</code> clause to win then <code>Relation#merge</code> can
be used.</p>
<pre><code class="hljs css language-ruby">User.active.merge(User.inactive)
<span class="hljs-comment"># SELECT "users".* FROM "users" WHERE "users"."state" = 'inactive'</span>
</code></pre>
<p>One important caveat is that <code>default_scope</code> will be prepended in
<code>scope</code> and <code>where</code> conditions.</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> &lt; ApplicationRecord</span>
  default_scope { where <span class="hljs-symbol">state:</span> <span class="hljs-string">'pending'</span> }
  scope <span class="hljs-symbol">:active</span>, -&gt; { where <span class="hljs-symbol">state:</span> <span class="hljs-string">'active'</span> }
  scope <span class="hljs-symbol">:inactive</span>, -&gt; { where <span class="hljs-symbol">state:</span> <span class="hljs-string">'inactive'</span> }
<span class="hljs-keyword">end</span>

User.all
<span class="hljs-comment"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending'</span>

User.active
<span class="hljs-comment"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending' AND "users"."state" = 'active'</span>

User.where(<span class="hljs-symbol">state:</span> <span class="hljs-string">'inactive'</span>)
<span class="hljs-comment"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending' AND "users"."state" = 'inactive'</span>
</code></pre>
<p>As you can see above the <code>default_scope</code> is being merged in both
<code>scope</code> and <code>where</code> conditions.</p>
<h3><a class="anchor" aria-hidden="true" id="removing-all-scoping"></a><a href="#removing-all-scoping" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Removing All Scoping</h3>
<p>If we wish to remove scoping for any reason we can use the <code>unscoped</code> method. This is
especially useful if a <code>default_scope</code> is specified in the model and should not be
applied for this particular query.</p>
<pre><code class="hljs css language-ruby">Client.unscoped.load
</code></pre>
<p>This method removes all scoping and will do a normal query on the table.</p>
<pre><code class="hljs css language-ruby">Client.unscoped.all
<span class="hljs-comment"># SELECT "clients".* FROM "clients"</span>

Client.where(<span class="hljs-symbol">published:</span> <span class="hljs-literal">false</span>).unscoped.all
<span class="hljs-comment"># SELECT "clients".* FROM "clients"</span>
</code></pre>
<p><code>unscoped</code> can also accept a block.</p>
<pre><code class="hljs css language-ruby">Client.unscoped {
  Client.created_before(Time.zone.now)
}
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="dynamic-finders"></a><a href="#dynamic-finders" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dynamic Finders</h2>
<p>For every field (also known as an attribute) you define in your table, Active Record provides a finder method. If you have a field called <code>first_name</code> on your <code>Client</code> model for example, you get <code>find_by_first_name</code> for free from Active Record. If you have a <code>locked</code> field on the <code>Client</code> model, you also get <code>find_by_locked</code> method.</p>
<p>You can specify an exclamation point (<code>!</code>) on the end of the dynamic finders to get them to raise an <code>ActiveRecord::RecordNotFound</code> error if they do not return any records, like <code>Client.find_by_name!(&quot;Ryan&quot;)</code></p>
<p>If you want to find both by name and locked, you can chain these finders together by simply typing &quot;<code>and</code>&quot; between the fields. For example, <code>Client.find_by_first_name_and_locked(&quot;Ryan&quot;, true)</code>.</p>
<h2><a class="anchor" aria-hidden="true" id="enums"></a><a href="#enums" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Enums</h2>
<p>The <code>enum</code> macro maps an integer column to a set of possible values.</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Book</span> &lt; ApplicationRecord</span>
  enum <span class="hljs-symbol">availability:</span> [<span class="hljs-symbol">:available</span>, <span class="hljs-symbol">:unavailable</span>]
<span class="hljs-keyword">end</span>
</code></pre>
<p>This will automatically create the corresponding <a href="#scopes">scopes</a> to query the
model. Methods to transition between states and query the current state are also
added.</p>
<pre><code class="hljs css language-ruby"><span class="hljs-comment"># Both examples below query just available books.</span>
Book.available
<span class="hljs-comment"># or</span>
Book.where(<span class="hljs-symbol">availability:</span> <span class="hljs-symbol">:available</span>)

book = Book.new(<span class="hljs-symbol">availability:</span> <span class="hljs-symbol">:available</span>)
book.available?   <span class="hljs-comment"># =&gt; true</span>
book.unavailable! <span class="hljs-comment"># =&gt; true</span>
book.available?   <span class="hljs-comment"># =&gt; false</span>
</code></pre>
<p>Read the full documentation about enums
<a href="https://api.rubyonrails.org/classes/ActiveRecord/Enum.html">in the Rails API docs</a>.</p>
<h2><a class="anchor" aria-hidden="true" id="understanding-the-method-chaining"></a><a href="#understanding-the-method-chaining" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Understanding The Method Chaining</h2>
<p>The Active Record pattern implements <a href="https://en.wikipedia.org/wiki/Method_chaining">Method Chaining</a>,
which allow us to use multiple Active Record methods together in a simple and straightforward way.</p>
<p>You can chain methods in a statement when the previous method called returns an
<code>ActiveRecord::Relation</code>, like <code>all</code>, <code>where</code>, and <code>joins</code>. Methods that return
a single object (see <a href="#retrieving-a-single-object">Retrieving a Single Object Section</a>)
have to be at the end of the statement.</p>
<p>There are some examples below. This guide won't cover all the possibilities, just a few as examples.
When an Active Record method is called, the query is not immediately generated and sent to the database,
this just happens when the data is actually needed. So each example below generates a single query.</p>
<h3><a class="anchor" aria-hidden="true" id="retrieving-filtered-data-from-multiple-tables"></a><a href="#retrieving-filtered-data-from-multiple-tables" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Retrieving filtered data from multiple tables</h3>
<pre><code class="hljs css language-ruby">Person
  .select(<span class="hljs-string">'people.id, people.name, comments.text'</span>)
  .joins(<span class="hljs-symbol">:comments</span>)
  .where(<span class="hljs-string">'comments.created_at &gt; ?'</span>, <span class="hljs-number">1</span>.week.ago)
</code></pre>
<p>The result should be something like this:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> people.id, people.name, comments.text
<span class="hljs-keyword">FROM</span> people
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> comments
  <span class="hljs-keyword">ON</span> comments.person_id = people.id
<span class="hljs-keyword">WHERE</span> comments.created_at &gt; <span class="hljs-string">'2015-01-01'</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="retrieving-specific-data-from-multiple-tables"></a><a href="#retrieving-specific-data-from-multiple-tables" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Retrieving specific data from multiple tables</h3>
<pre><code class="hljs css language-ruby">Person
  .select(<span class="hljs-string">'people.id, people.name, companies.name'</span>)
  .joins(<span class="hljs-symbol">:company</span>)
  .find_by(<span class="hljs-string">'people.name'</span> =&gt; <span class="hljs-string">'John'</span>) <span class="hljs-comment"># this should be the last</span>
</code></pre>
<p>The above should generate:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> people.id, people.name, companies.name
<span class="hljs-keyword">FROM</span> people
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> companies
  <span class="hljs-keyword">ON</span> companies.person_id = people.id
<span class="hljs-keyword">WHERE</span> people.name = <span class="hljs-string">'John'</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>
</code></pre>
<p>NOTE: Note that if a query matches multiple records, <code>find_by</code> will
fetch only the first one and ignore the others (see the <code>LIMIT 1</code>
statement above).</p>
<h2><a class="anchor" aria-hidden="true" id="find-or-build-a-new-object"></a><a href="#find-or-build-a-new-object" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Find or Build a New Object</h2>
<p>It's common that you need to find a record or create it if it doesn't exist. You can do that with the <code>find_or_create_by</code> and <code>find_or_create_by!</code> methods.</p>
<h3><a class="anchor" aria-hidden="true" id="find_or_create_by"></a><a href="#find_or_create_by" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>find_or_create_by</code></h3>
<p>The <code>find_or_create_by</code> method checks whether a record with the specified attributes exists. If it doesn't, then <code>create</code> is called. Let's see an example.</p>
<p>Suppose you want to find a client named 'Andy', and if there's none, create one. You can do so by running:</p>
<pre><code class="hljs css language-ruby">Client.find_or_create_by(<span class="hljs-symbol">first_name:</span> <span class="hljs-string">'Andy'</span>)
<span class="hljs-comment"># =&gt; #&lt;Client id: 1, first_name: "Andy", orders_count: 0, locked: true, created_at: "2011-08-30 06:09:27", updated_at: "2011-08-30 06:09:27"&gt;</span>
</code></pre>
<p>The SQL generated by this method looks like this:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> clients <span class="hljs-keyword">WHERE</span> (clients.first_name = <span class="hljs-string">'Andy'</span>) <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">BEGIN</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> clients (created_at, first_name, <span class="hljs-keyword">locked</span>, orders_count, updated_at) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'2011-08-30 05:22:57'</span>, <span class="hljs-string">'Andy'</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-string">'2011-08-30 05:22:57'</span>)
<span class="hljs-keyword">COMMIT</span>
</code></pre>
<p><code>find_or_create_by</code> returns either the record that already exists or the new record. In our case, we didn't already have a client named Andy so the record is created and returned.</p>
<p>The new record might not be saved to the database; that depends on whether validations passed or not (just like <code>create</code>).</p>
<p>Suppose we want to set the 'locked' attribute to <code>false</code> if we're
creating a new record, but we don't want to include it in the query. So
we want to find the client named &quot;Andy&quot;, or if that client doesn't
exist, create a client named &quot;Andy&quot; which is not locked.</p>
<p>We can achieve this in two ways. The first is to use <code>create_with</code>:</p>
<pre><code class="hljs css language-ruby">Client.create_with(<span class="hljs-symbol">locked:</span> <span class="hljs-literal">false</span>).find_or_create_by(<span class="hljs-symbol">first_name:</span> <span class="hljs-string">'Andy'</span>)
</code></pre>
<p>The second way is using a block:</p>
<pre><code class="hljs css language-ruby">Client.find_or_create_by(<span class="hljs-symbol">first_name:</span> <span class="hljs-string">'Andy'</span>) <span class="hljs-keyword">do</span> <span class="hljs-params">|c|</span>
  c.locked = <span class="hljs-literal">false</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>The block will only be executed if the client is being created. The
second time we run this code, the block will be ignored.</p>
<h3><a class="anchor" aria-hidden="true" id="find_or_create_by-1"></a><a href="#find_or_create_by-1" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>find_or_create_by!</code></h3>
<p>You can also use <code>find_or_create_by!</code> to raise an exception if the new record is invalid. Validations are not covered on this guide, but let's assume for a moment that you temporarily add</p>
<pre><code class="hljs css language-ruby">validates <span class="hljs-symbol">:orders_count</span>, <span class="hljs-symbol">presence:</span> <span class="hljs-literal">true</span>
</code></pre>
<p>to your <code>Client</code> model. If you try to create a new <code>Client</code> without passing an <code>orders_count</code>, the record will be invalid and an exception will be raised:</p>
<pre><code class="hljs css language-ruby">Client.find_or_create_by!(<span class="hljs-symbol">first_name:</span> <span class="hljs-string">'Andy'</span>)
<span class="hljs-comment"># =&gt; ActiveRecord::RecordInvalid: Validation failed: Orders count can't be blank</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="find_or_initialize_by"></a><a href="#find_or_initialize_by" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>find_or_initialize_by</code></h3>
<p>The <code>find_or_initialize_by</code> method will work just like
<code>find_or_create_by</code> but it will call <code>new</code> instead of <code>create</code>. This
means that a new model instance will be created in memory but won't be
saved to the database. Continuing with the <code>find_or_create_by</code> example, we
now want the client named 'Nick':</p>
<pre><code class="hljs css language-ruby">nick = Client.find_or_initialize_by(<span class="hljs-symbol">first_name:</span> <span class="hljs-string">'Nick'</span>)
<span class="hljs-comment"># =&gt; #&lt;Client id: nil, first_name: "Nick", orders_count: 0, locked: true, created_at: "2011-08-30 06:09:27", updated_at: "2011-08-30 06:09:27"&gt;</span>

nick.persisted?
<span class="hljs-comment"># =&gt; false</span>

nick.new_record?
<span class="hljs-comment"># =&gt; true</span>
</code></pre>
<p>Because the object is not yet stored in the database, the SQL generated looks like this:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> clients <span class="hljs-keyword">WHERE</span> (clients.first_name = <span class="hljs-string">'Nick'</span>) <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>
</code></pre>
<p>When you want to save it to the database, just call <code>save</code>:</p>
<pre><code class="hljs css language-ruby">nick.save
<span class="hljs-comment"># =&gt; true</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="finding-by-sql"></a><a href="#finding-by-sql" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Finding by SQL</h2>
<p>If you'd like to use your own SQL to find records in a table you can use <code>find_by_sql</code>. The <code>find_by_sql</code> method will return an array of objects even if the underlying query returns just a single record. For example you could run this query:</p>
<pre><code class="hljs css language-ruby">Client.find_by_sql(<span class="hljs-string">"SELECT * FROM clients
  INNER JOIN orders ON clients.id = orders.client_id
  ORDER BY clients.created_at desc"</span>)
<span class="hljs-comment"># =&gt;  [</span>
<span class="hljs-comment">#   #&lt;Client id: 1, first_name: "Lucas" &gt;,</span>
<span class="hljs-comment">#   #&lt;Client id: 2, first_name: "Jan" &gt;,</span>
<span class="hljs-comment">#   ...</span>
<span class="hljs-comment"># ]</span>
</code></pre>
<p><code>find_by_sql</code> provides you with a simple way of making custom calls to the database and retrieving instantiated objects.</p>
<h3><a class="anchor" aria-hidden="true" id="select_all"></a><a href="#select_all" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>select_all</code></h3>
<p><code>find_by_sql</code> has a close relative called <code>connection#select_all</code>. <code>select_all</code> will retrieve
objects from the database using custom SQL just like <code>find_by_sql</code> but will not instantiate them.
This method will return an instance of <code>ActiveRecord::Result</code> class and calling <code>to_a</code> on this
object would return you an array of hashes where each hash indicates a record.</p>
<pre><code class="hljs css language-ruby">Client.connection.select_all(<span class="hljs-string">"SELECT first_name, created_at FROM clients WHERE id = '1'"</span>).to_a
<span class="hljs-comment"># =&gt; [</span>
<span class="hljs-comment">#   {"first_name"=&gt;"Rafael", "created_at"=&gt;"2012-11-10 23:23:45.281189"},</span>
<span class="hljs-comment">#   {"first_name"=&gt;"Eileen", "created_at"=&gt;"2013-12-09 11:22:35.221282"}</span>
<span class="hljs-comment"># ]</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="pluck"></a><a href="#pluck" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>pluck</code></h3>
<p><code>pluck</code> can be used to query single or multiple columns from the underlying table of a model. It accepts a list of column names as argument and returns an array of values of the specified columns with the corresponding data type.</p>
<pre><code class="hljs css language-ruby">Client.where(<span class="hljs-symbol">active:</span> <span class="hljs-literal">true</span>).pluck(<span class="hljs-symbol">:id</span>)
<span class="hljs-comment"># SELECT id FROM clients WHERE active = 1</span>
<span class="hljs-comment"># =&gt; [1, 2, 3]</span>

Client.distinct.pluck(<span class="hljs-symbol">:role</span>)
<span class="hljs-comment"># SELECT DISTINCT role FROM clients</span>
<span class="hljs-comment"># =&gt; ['admin', 'member', 'guest']</span>

Client.pluck(<span class="hljs-symbol">:id</span>, <span class="hljs-symbol">:name</span>)
<span class="hljs-comment"># SELECT clients.id, clients.name FROM clients</span>
<span class="hljs-comment"># =&gt; [[1, 'David'], [2, 'Jeremy'], [3, 'Jose']]</span>
</code></pre>
<p><code>pluck</code> makes it possible to replace code like:</p>
<pre><code class="hljs css language-ruby">Client.select(<span class="hljs-symbol">:id</span>).map { <span class="hljs-params">|c|</span> c.id }
<span class="hljs-comment"># or</span>
Client.select(<span class="hljs-symbol">:id</span>).map(&amp;<span class="hljs-symbol">:id</span>)
<span class="hljs-comment"># or</span>
Client.select(<span class="hljs-symbol">:id</span>, <span class="hljs-symbol">:name</span>).map { <span class="hljs-params">|c|</span> [c.id, c.name] }
</code></pre>
<p>with:</p>
<pre><code class="hljs css language-ruby">Client.pluck(<span class="hljs-symbol">:id</span>)
<span class="hljs-comment"># or</span>
Client.pluck(<span class="hljs-symbol">:id</span>, <span class="hljs-symbol">:name</span>)
</code></pre>
<p>Unlike <code>select</code>, <code>pluck</code> directly converts a database result into a Ruby <code>Array</code>,
without constructing <code>ActiveRecord</code> objects. This can mean better performance for
a large or often-running query. However, any model method overrides will
not be available. For example:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Client</span> &lt; ApplicationRecord</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">name</span></span>
    <span class="hljs-string">"I am <span class="hljs-subst">#{<span class="hljs-keyword">super</span>}</span>"</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

Client.select(<span class="hljs-symbol">:name</span>).map &amp;<span class="hljs-symbol">:name</span>
<span class="hljs-comment"># =&gt; ["I am David", "I am Jeremy", "I am Jose"]</span>

Client.pluck(<span class="hljs-symbol">:name</span>)
<span class="hljs-comment"># =&gt; ["David", "Jeremy", "Jose"]</span>
</code></pre>
<p>You are not limited to querying fields from a single table, you can query multiple tables as well.</p>
<pre><code class="hljs"><span class="hljs-selector-tag">Client</span><span class="hljs-selector-class">.joins</span>(<span class="hljs-selector-pseudo">:comments</span>, <span class="hljs-selector-pseudo">:categories).pluck("clients.email</span>, <span class="hljs-selector-tag">comments</span><span class="hljs-selector-class">.title</span>, <span class="hljs-selector-tag">categories</span><span class="hljs-selector-class">.name</span>")
</code></pre>
<p>Furthermore, unlike <code>select</code> and other <code>Relation</code> scopes, <code>pluck</code> triggers an immediate
query, and thus cannot be chained with any further scopes, although it can work with
scopes already constructed earlier:</p>
<pre><code class="hljs css language-ruby">Client.pluck(<span class="hljs-symbol">:name</span>).limit(<span class="hljs-number">1</span>)
<span class="hljs-comment"># =&gt; NoMethodError: undefined method `limit' for #&lt;Array:0x007ff34d3ad6d8&gt;</span>

Client.limit(<span class="hljs-number">1</span>).pluck(<span class="hljs-symbol">:name</span>)
<span class="hljs-comment"># =&gt; ["David"]</span>
</code></pre>
<p>NOTE: You should also know that using <code>pluck</code> will trigger eager loading if the relation object contains include values, even if the eager loading is not necessary for the query. For example:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-comment"># store association for reusing it</span>
assoc = Company.includes(<span class="hljs-symbol">:account</span>)
assoc.pluck(<span class="hljs-symbol">:id</span>)
<span class="hljs-comment"># SELECT "companies"."id" FROM "companies" LEFT OUTER JOIN "accounts" ON "accounts"."id" = "companies"."account_id"</span>
</code></pre>
<p>One way to avoid this is to <code>unscope</code> the includes:</p>
<pre><code class="hljs css language-ruby">assoc.unscope(<span class="hljs-symbol">:includes</span>).pluck(<span class="hljs-symbol">:id</span>)
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="ids"></a><a href="#ids" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>ids</code></h3>
<p><code>ids</code> can be used to pluck all the IDs for the relation using the table's primary key.</p>
<pre><code class="hljs css language-ruby">Person.ids
<span class="hljs-comment"># SELECT id FROM people</span>
</code></pre>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> &lt; ApplicationRecord</span>
  <span class="hljs-keyword">self</span>.primary_key = <span class="hljs-string">"person_id"</span>
<span class="hljs-keyword">end</span>

Person.ids
<span class="hljs-comment"># SELECT person_id FROM people</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="existence-of-objects"></a><a href="#existence-of-objects" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Existence of Objects</h2>
<p>If you simply want to check for the existence of the object there's a method called <code>exists?</code>.
This method will query the database using the same query as <code>find</code>, but instead of returning an
object or collection of objects it will return either <code>true</code> or <code>false</code>.</p>
<pre><code class="hljs css language-ruby">Client.exists?(<span class="hljs-number">1</span>)
</code></pre>
<p>The <code>exists?</code> method also takes multiple values, but the catch is that it will return <code>true</code> if any
one of those records exists.</p>
<pre><code class="hljs css language-ruby">Client.exists?(<span class="hljs-symbol">id:</span> [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>])
<span class="hljs-comment"># or</span>
Client.exists?(<span class="hljs-symbol">name:</span> [<span class="hljs-string">'John'</span>, <span class="hljs-string">'Sergei'</span>])
</code></pre>
<p>It's even possible to use <code>exists?</code> without any arguments on a model or a relation.</p>
<pre><code class="hljs css language-ruby">Client.where(<span class="hljs-symbol">first_name:</span> <span class="hljs-string">'Ryan'</span>).exists?
</code></pre>
<p>The above returns <code>true</code> if there is at least one client with the <code>first_name</code> 'Ryan' and <code>false</code>
otherwise.</p>
<pre><code class="hljs css language-ruby">Client.exists?
</code></pre>
<p>The above returns <code>false</code> if the <code>clients</code> table is empty and <code>true</code> otherwise.</p>
<p>You can also use <code>any?</code> and <code>many?</code> to check for existence on a model or relation.</p>
<pre><code class="hljs css language-ruby"><span class="hljs-comment"># via a model</span>
Article.any?
Article.many?

<span class="hljs-comment"># via a named scope</span>
Article.recent.any?
Article.recent.many?

<span class="hljs-comment"># via a relation</span>
Article.where(<span class="hljs-symbol">published:</span> <span class="hljs-literal">true</span>).any?
Article.where(<span class="hljs-symbol">published:</span> <span class="hljs-literal">true</span>).many?

<span class="hljs-comment"># via an association</span>
Article.first.categories.any?
Article.first.categories.many?
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="calculations"></a><a href="#calculations" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Calculations</h2>
<p>This section uses count as an example method in this preamble, but the options described apply to all sub-sections.</p>
<p>All calculation methods work directly on a model:</p>
<pre><code class="hljs css language-ruby">Client.count
<span class="hljs-comment"># SELECT COUNT(*) FROM clients</span>
</code></pre>
<p>Or on a relation:</p>
<pre><code class="hljs css language-ruby">Client.where(<span class="hljs-symbol">first_name:</span> <span class="hljs-string">'Ryan'</span>).count
<span class="hljs-comment"># SELECT COUNT(*) FROM clients WHERE (first_name = 'Ryan')</span>
</code></pre>
<p>You can also use various finder methods on a relation for performing complex calculations:</p>
<pre><code class="hljs css language-ruby">Client.includes(<span class="hljs-string">"orders"</span>).where(<span class="hljs-symbol">first_name:</span> <span class="hljs-string">'Ryan'</span>, <span class="hljs-symbol">orders:</span> { <span class="hljs-symbol">status:</span> <span class="hljs-string">'received'</span> }).count
</code></pre>
<p>Which will execute:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> clients.id) <span class="hljs-keyword">FROM</span> clients
  <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> orders <span class="hljs-keyword">ON</span> orders.client_id = clients.id
  <span class="hljs-keyword">WHERE</span> (clients.first_name = <span class="hljs-string">'Ryan'</span> <span class="hljs-keyword">AND</span> orders.status = <span class="hljs-string">'received'</span>)
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="count"></a><a href="#count" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Count</h3>
<p>If you want to see how many records are in your model's table you could call <code>Client.count</code> and that will return the number. If you want to be more specific and find all the clients with their age present in the database you can use <code>Client.count(:age)</code>.</p>
<p>For options, please see the parent section, <a href="#calculations">Calculations</a>.</p>
<h3><a class="anchor" aria-hidden="true" id="average"></a><a href="#average" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Average</h3>
<p>If you want to see the average of a certain number in one of your tables you can call the <code>average</code> method on the class that relates to the table. This method call will look something like this:</p>
<pre><code class="hljs css language-ruby">Client.average(<span class="hljs-string">"orders_count"</span>)
</code></pre>
<p>This will return a number (possibly a floating point number such as 3.14159265) representing the average value in the field.</p>
<p>For options, please see the parent section, <a href="#calculations">Calculations</a>.</p>
<h3><a class="anchor" aria-hidden="true" id="minimum"></a><a href="#minimum" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Minimum</h3>
<p>If you want to find the minimum value of a field in your table you can call the <code>minimum</code> method on the class that relates to the table. This method call will look something like this:</p>
<pre><code class="hljs css language-ruby">Client.minimum(<span class="hljs-string">"age"</span>)
</code></pre>
<p>For options, please see the parent section, <a href="#calculations">Calculations</a>.</p>
<h3><a class="anchor" aria-hidden="true" id="maximum"></a><a href="#maximum" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Maximum</h3>
<p>If you want to find the maximum value of a field in your table you can call the <code>maximum</code> method on the class that relates to the table. This method call will look something like this:</p>
<pre><code class="hljs css language-ruby">Client.maximum(<span class="hljs-string">"age"</span>)
</code></pre>
<p>For options, please see the parent section, <a href="#calculations">Calculations</a>.</p>
<h3><a class="anchor" aria-hidden="true" id="sum"></a><a href="#sum" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sum</h3>
<p>If you want to find the sum of a field for all records in your table you can call the <code>sum</code> method on the class that relates to the table. This method call will look something like this:</p>
<pre><code class="hljs css language-ruby">Client.sum(<span class="hljs-string">"orders_count"</span>)
</code></pre>
<p>For options, please see the parent section, <a href="#calculations">Calculations</a>.</p>
<h2><a class="anchor" aria-hidden="true" id="running-explain"></a><a href="#running-explain" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Running EXPLAIN</h2>
<p>You can run EXPLAIN on the queries triggered by relations. For example,</p>
<pre><code class="hljs css language-ruby">User.where(<span class="hljs-symbol">id:</span> <span class="hljs-number">1</span>).joins(<span class="hljs-symbol">:articles</span>).explain
</code></pre>
<p>may yield</p>
<pre><code class="hljs"><span class="hljs-section">EXPLAIN for: SELECT `users`.* FROM `users` INNER JOIN `articles` ON `articles`.`user_id` = `users`.`id` WHERE `users`.`id` = 1
+----+-------------+----------+-------+---------------+</span>
<span class="hljs-section">| id | select_type | table    | type  | possible_keys |
+----+-------------+----------+-------+---------------+</span>
|  1 | SIMPLE      | users    | const | PRIMARY       |
<span class="hljs-section">|  1 | SIMPLE      | articles | ALL   | NULL          |
+----+-------------+----------+-------+---------------+</span>
<span class="hljs-code">+---------+</span>---------<span class="hljs-code">+-------+</span>------<span class="hljs-code">+-------------+</span>
<span class="hljs-section">| key     | key_len | ref   | rows | Extra       |
+---------+---------+-------+------+-------------+</span>
| PRIMARY | 4       | const |    1 |             |
<span class="hljs-section">| NULL    | NULL    | NULL  |    1 | Using where |
+---------+---------+-------+------+-------------+</span>

2 rows in set (0.00 sec)
</code></pre>
<p>under MySQL and MariaDB.</p>
<p>Active Record performs a pretty printing that emulates that of the
corresponding database shell. So, the same query running with the
PostgreSQL adapter would yield instead</p>
<pre><code class="hljs"><span class="hljs-keyword">EXPLAIN</span> <span class="hljs-keyword">for</span>: <span class="hljs-keyword">SELECT</span> <span class="hljs-string">"users"</span>.* <span class="hljs-keyword">FROM</span> <span class="hljs-string">"users"</span> <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> <span class="hljs-string">"articles"</span> <span class="hljs-keyword">ON</span> <span class="hljs-string">"articles"</span>.<span class="hljs-string">"user_id"</span> = <span class="hljs-string">"users"</span>.<span class="hljs-string">"id"</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-string">"users"</span>.<span class="hljs-string">"id"</span> = <span class="hljs-number">1</span>
                                  <span class="hljs-keyword">QUERY</span> PLAN
<span class="hljs-comment">------------------------------------------------------------------------------</span>
 <span class="hljs-keyword">Nested</span> <span class="hljs-keyword">Loop</span> <span class="hljs-keyword">Left</span> <span class="hljs-keyword">Join</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.00</span>.<span class="hljs-number">.37</span><span class="hljs-number">.24</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">8</span> width=<span class="hljs-number">0</span>)
   <span class="hljs-keyword">Join</span> Filter: (articles.user_id = users.id)
   -&gt;  <span class="hljs-keyword">Index</span> <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">using</span> users_pkey <span class="hljs-keyword">on</span> <span class="hljs-keyword">users</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.00</span>.<span class="hljs-number">.8</span><span class="hljs-number">.27</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1</span> width=<span class="hljs-number">4</span>)
         <span class="hljs-keyword">Index</span> Cond: (<span class="hljs-keyword">id</span> = <span class="hljs-number">1</span>)
   -&gt;  Seq <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">on</span> articles  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.00</span>.<span class="hljs-number">.28</span><span class="hljs-number">.88</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">8</span> width=<span class="hljs-number">4</span>)
         Filter: (articles.user_id = <span class="hljs-number">1</span>)
(<span class="hljs-number">6</span> <span class="hljs-keyword">rows</span>)
</code></pre>
<p>Eager loading may trigger more than one query under the hood, and some queries
may need the results of previous ones. Because of that, <code>explain</code> actually
executes the query, and then asks for the query plans. For example,</p>
<pre><code class="hljs css language-ruby">User.where(<span class="hljs-symbol">id:</span> <span class="hljs-number">1</span>).includes(<span class="hljs-symbol">:articles</span>).explain
</code></pre>
<p>yields</p>
<pre><code class="hljs"><span class="hljs-section">EXPLAIN for: SELECT `users`.* FROM `users`  WHERE `users`.`id` = 1
+----+-------------+-------+-------+---------------+</span>
<span class="hljs-section">| id | select_type | table | type  | possible_keys |
+----+-------------+-------+-------+---------------+</span>
<span class="hljs-section">|  1 | SIMPLE      | users | const | PRIMARY       |
+----+-------------+-------+-------+---------------+</span>
<span class="hljs-code">+---------+</span>---------<span class="hljs-code">+-------+</span>------<span class="hljs-code">+-------+</span>
<span class="hljs-section">| key     | key_len | ref   | rows | Extra |
+---------+---------+-------+------+-------+</span>
<span class="hljs-section">| PRIMARY | 4       | const |    1 |       |
+---------+---------+-------+------+-------+</span>

1 row in set (0.00 sec)

<span class="hljs-section">EXPLAIN for: SELECT `articles`.* FROM `articles`  WHERE `articles`.`user_id` IN (1)
+----+-------------+----------+------+---------------+</span>
<span class="hljs-section">| id | select_type | table    | type | possible_keys |
+----+-------------+----------+------+---------------+</span>
<span class="hljs-section">|  1 | SIMPLE      | articles | ALL  | NULL          |
+----+-------------+----------+------+---------------+</span>
<span class="hljs-code">+------+</span>---------<span class="hljs-code">+------+</span>------<span class="hljs-code">+-------------+</span>
<span class="hljs-section">| key  | key_len | ref  | rows | Extra       |
+------+---------+------+------+-------------+</span>
<span class="hljs-section">| NULL | NULL    | NULL |    1 | Using where |
+------+---------+------+------+-------------+</span>


1 row in set (0.00 sec)
</code></pre>
<p>under MySQL and MariaDB.</p>
<h3><a class="anchor" aria-hidden="true" id="interpreting-explain"></a><a href="#interpreting-explain" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Interpreting EXPLAIN</h3>
<p>Interpretation of the output of EXPLAIN is beyond the scope of this guide. The
following pointers may be helpful:</p>
<ul>
<li><p>SQLite3: <a href="https://www.sqlite.org/eqp.html">EXPLAIN QUERY PLAN</a></p></li>
<li><p>MySQL: <a href="https://dev.mysql.com/doc/refman/5.7/en/explain-output.html">EXPLAIN Output Format</a></p></li>
<li><p>MariaDB: <a href="https://mariadb.com/kb/en/mariadb/explain/">EXPLAIN</a></p></li>
<li><p>PostgreSQL: <a href="https://www.postgresql.org/docs/current/static/using-explain.html">Using EXPLAIN</a></p></li>
</ul>
</span></div></article></div><div class="docLastUpdate"><em>Last updated on 2019-7-7</em></div><div class="docs-prevnext"><a class="docs-prev button" href="/rails-setup/docs/rails/active-record-associations"><span class="arrow-prev">← </span><span>Active Record Associations</span></a><a class="docs-next button" href="/rails-setup/docs/rails/multiple-databases"><span>Multiple Databases with Active Record</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#retrieving-objects-from-the-database">Retrieving Objects from the Database</a><ul class="toc-headings"><li><a href="#retrieving-a-single-object">Retrieving a Single Object</a></li><li><a href="#retrieving-multiple-objects-in-batches">Retrieving Multiple Objects in Batches</a></li></ul></li><li><a href="#conditions">Conditions</a><ul class="toc-headings"><li><a href="#pure-string-conditions">Pure String Conditions</a></li><li><a href="#array-conditions">Array Conditions</a></li><li><a href="#hash-conditions">Hash Conditions</a></li><li><a href="#not-conditions">NOT Conditions</a></li><li><a href="#or-conditions">OR Conditions</a></li></ul></li><li><a href="#ordering">Ordering</a></li><li><a href="#selecting-specific-fields">Selecting Specific Fields</a></li><li><a href="#limit-and-offset">Limit and Offset</a></li><li><a href="#group">Group</a><ul class="toc-headings"><li><a href="#total-of-grouped-items">Total of grouped items</a></li></ul></li><li><a href="#having">Having</a></li><li><a href="#overriding-conditions">Overriding Conditions</a><ul class="toc-headings"><li><a href="#unscope"><code>unscope</code></a></li><li><a href="#only"><code>only</code></a></li><li><a href="#reselect"><code>reselect</code></a></li><li><a href="#reorder"><code>reorder</code></a></li><li><a href="#reverse_order"><code>reverse_order</code></a></li><li><a href="#rewhere"><code>rewhere</code></a></li></ul></li><li><a href="#null-relation">Null Relation</a></li><li><a href="#readonly-objects">Readonly Objects</a></li><li><a href="#locking-records-for-update">Locking Records for Update</a><ul class="toc-headings"><li><a href="#optimistic-locking">Optimistic Locking</a></li><li><a href="#pessimistic-locking">Pessimistic Locking</a></li></ul></li><li><a href="#joining-tables">Joining Tables</a><ul class="toc-headings"><li><a href="#joins"><code>joins</code></a></li><li><a href="#left_outer_joins"><code>left_outer_joins</code></a></li></ul></li><li><a href="#eager-loading-associations">Eager Loading Associations</a><ul class="toc-headings"><li><a href="#eager-loading-multiple-associations">Eager Loading Multiple Associations</a></li><li><a href="#specifying-conditions-on-eager-loaded-associations">Specifying Conditions on Eager Loaded Associations</a></li></ul></li><li><a href="#scopes">Scopes</a><ul class="toc-headings"><li><a href="#passing-in-arguments">Passing in arguments</a></li><li><a href="#using-conditionals">Using conditionals</a></li><li><a href="#applying-a-default-scope">Applying a default scope</a></li><li><a href="#merging-of-scopes">Merging of scopes</a></li><li><a href="#removing-all-scoping">Removing All Scoping</a></li></ul></li><li><a href="#dynamic-finders">Dynamic Finders</a></li><li><a href="#enums">Enums</a></li><li><a href="#understanding-the-method-chaining">Understanding The Method Chaining</a><ul class="toc-headings"><li><a href="#retrieving-filtered-data-from-multiple-tables">Retrieving filtered data from multiple tables</a></li><li><a href="#retrieving-specific-data-from-multiple-tables">Retrieving specific data from multiple tables</a></li></ul></li><li><a href="#find-or-build-a-new-object">Find or Build a New Object</a><ul class="toc-headings"><li><a href="#find_or_create_by"><code>find_or_create_by</code></a></li><li><a href="#find_or_create_by-1"><code>find_or_create_by!</code></a></li><li><a href="#find_or_initialize_by"><code>find_or_initialize_by</code></a></li></ul></li><li><a href="#finding-by-sql">Finding by SQL</a><ul class="toc-headings"><li><a href="#select_all"><code>select_all</code></a></li><li><a href="#pluck"><code>pluck</code></a></li><li><a href="#ids"><code>ids</code></a></li></ul></li><li><a href="#existence-of-objects">Existence of Objects</a></li><li><a href="#calculations">Calculations</a><ul class="toc-headings"><li><a href="#count">Count</a></li><li><a href="#average">Average</a></li><li><a href="#minimum">Minimum</a></li><li><a href="#maximum">Maximum</a></li><li><a href="#sum">Sum</a></li></ul></li><li><a href="#running-explain">Running EXPLAIN</a><ul class="toc-headings"><li><a href="#interpreting-explain">Interpreting EXPLAIN</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="copyright">Rails Setup 2019</section></footer></div></body></html>