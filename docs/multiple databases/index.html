<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Multiple Databases with Active Record · Rails Setup</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;p&gt;This guide covers using multiple databases with your Rails application.&lt;/p&gt;
"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Multiple Databases with Active Record · Rails Setup"/><meta property="og:type" content="website"/><meta property="og:url" content="https://HenryTabima.github.io/rails-setup/"/><meta property="og:description" content="&lt;p&gt;This guide covers using multiple databases with your Rails application.&lt;/p&gt;
"/><meta property="og:image" content="https://HenryTabima.github.io/rails-setup/img/undraw_online.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://HenryTabima.github.io/rails-setup/img/undraw_tweetstorm.svg"/><link rel="shortcut icon" href="/rails-setup/img/favicon.ico"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/rails-setup/js/scrollSpy.js"></script><link rel="stylesheet" href="/rails-setup/css/main.css"/><script src="/rails-setup/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/rails-setup/"><img class="logo" src="/rails-setup/img/favicon.ico" alt="Rails Setup"/><h2 class="headerTitleWithLogo">Rails Setup</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/rails-setup/docs/getting started" target="_self">Rails Docs</a></li><li class=""><a href="https://github.com/HenryTabima/rails-setup" target="_self">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Models</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Start Here</h3><ul class=""><li class="navListItem"><a class="navItem" href="/rails-setup/docs/getting started">Getting Started with Rails</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/development dependencies install">Development Dependencies Install</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Models</h3><ul class=""><li class="navListItem"><a class="navItem" href="/rails-setup/docs/active record basics">Active Record Basics</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/active record migrations">Active Record Migrations</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/active record validations">Active Record Validations</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/active record callbacks">Active Record Callbacks</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/active record associations">Active Record Associations</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/active record query">Active Record Query Interface</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/rails-setup/docs/multiple databases">Multiple Databases with Active Record</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/active record postgresql">Active Record and PostgreSQL</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Views</h3><ul class=""><li class="navListItem"><a class="navItem" href="/rails-setup/docs/layouts and rendering">Layouts and Rendering in Rails</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/action view">Action View Overview</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/action view form helpers">Action View Form Helpers</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Controllers</h3><ul class=""><li class="navListItem"><a class="navItem" href="/rails-setup/docs/action controller">Action Controller Overview</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails routing">Rails Routing from the Outside In</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Other Components</h3><ul class=""><li class="navListItem"><a class="navItem" href="/rails-setup/docs/active support core">Active Support Core Extensions</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/active support instrumentation">Active Support Instrumentation</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/action mailer">Action Mailer Basics</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/action mailbox">Action Mailbox Basics</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/active model">Active Model Basics</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/active job">Active Job Basics</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/action text">Action Text Overview</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/active storage">Active Storage Overview</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/action cable">Action Cable Overview</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Digging Deeper</h3><ul class=""><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails i18n">Rails Internationalization (I18n) API</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/testing rails">Testing Rails Applications</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/securing rails">Securing Rails Applications</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/debugging rails">Debugging Rails Applications</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/configuring rails">Configuring Rails Applications</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails command line">The Rails Command Line</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/asset pipeline">The Asset Pipeline</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/working with javascript">Working with JavaScript in Rails</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/autoloading and reloading">Autoloading and Reloading Constants</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/caching with rails">Caching with Rails: An Overview</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/api only apps">Using Rails for API-only Applications</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/threading">Threading and Code Execution in Rails</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/initialization">The Rails Initialization Process</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/engines">Getting Started with Engines</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Extending Rails</h3><ul class=""><li class="navListItem"><a class="navItem" href="/rails-setup/docs/rails on rack">Rails on Rack</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/generators &amp; templates">Creating and Customizing Rails Generators &amp; Templates</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/application templates">Rails Application Templates</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/creating rails plugins">The Basics of Creating Rails Plugins</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Contributions</h3><ul class=""><li class="navListItem"><a class="navItem" href="/rails-setup/docs/contributing to rails">Contributing to Ruby on Rails</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/api documentation">API Documentation Guidelines</a></li><li class="navListItem"><a class="navItem" href="/rails-setup/docs/guides guidelines">Ruby on Rails Guides Guidelines</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Policies</h3><ul class=""><li class="navListItem"><a class="navItem" href="/rails-setup/docs/maintenance policy">Maintenance Policy for Ruby on Rails</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Multiple Databases with Active Record</h1></header><article><div><span><p>This guide covers using multiple databases with your Rails application.</p>
<p>After reading this guide you will know:</p>
<ul>
<li>How to setup your application for multiple databases.</li>
<li>How automatic connection switching works.</li>
<li>What features are supported and what's still a work in progress.</li>
</ul>
<hr>
<p>As an application grows in popularity and usage you'll need to scale the application
to support your new users and their data. One way in which your application may need
to scale is on the database level. Rails now has support for multiple databases
so you don't have to store your data all in one place.</p>
<p>At this time the following features are supported:</p>
<ul>
<li>Multiple primary databases and a replica for each</li>
<li>Automatic connection switching for the model you're working with</li>
<li>Automatic swapping between the primary and replica depending on the HTTP verb
and recent writes</li>
<li>Rails tasks for creating, dropping, migrating, and interacting with the multiple
databases</li>
</ul>
<p>The following features are not (yet) supported:</p>
<ul>
<li>Sharding</li>
<li>Joining across clusters</li>
<li>Load balancing replicas</li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="setting-up-your-application"></a><a href="#setting-up-your-application" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Setting up your application</h2>
<p>While Rails tries to do most of the work for you there are still some steps you'll
need to do to get your application ready for multiple databases.</p>
<p>Let's say we have an application with a single primary database and we need to add a
new database for some new tables we're adding. The name of the new database will be
&quot;animals&quot;.</p>
<p>The database.yml looks like this:</p>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">production:</span>
<span class="hljs-attr">  database:</span> <span class="hljs-string">my_primary_database</span>
<span class="hljs-attr">  user:</span> <span class="hljs-string">root</span>
<span class="hljs-attr">  adapter:</span> <span class="hljs-string">mysql</span>
</code></pre>
<p>Let's add a replica for the primary, a new writer called animals and a replica for that
as well. To do this we need to change our database.yml from a 2-tier to a 3-tier config.</p>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">production:</span>
<span class="hljs-attr">  primary:</span>
<span class="hljs-attr">    database:</span> <span class="hljs-string">my_primary_database</span>
<span class="hljs-attr">    user:</span> <span class="hljs-string">root</span>
<span class="hljs-attr">    adapter:</span> <span class="hljs-string">mysql</span>
<span class="hljs-attr">  primary_replica:</span>
<span class="hljs-attr">    database:</span> <span class="hljs-string">my_primary_database</span>
<span class="hljs-attr">    user:</span> <span class="hljs-string">root_readonly</span>
<span class="hljs-attr">    adapter:</span> <span class="hljs-string">mysql</span>
<span class="hljs-attr">    replica:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">  animals:</span>
<span class="hljs-attr">    database:</span> <span class="hljs-string">my_animals_database</span>
<span class="hljs-attr">    user:</span> <span class="hljs-string">animals_root</span>
<span class="hljs-attr">    adapter:</span> <span class="hljs-string">mysql</span>
<span class="hljs-attr">    migrations_paths:</span> <span class="hljs-string">db/animals_migrate</span>
<span class="hljs-attr">  animals_replica:</span>
<span class="hljs-attr">    database:</span> <span class="hljs-string">my_animals_database</span>
<span class="hljs-attr">    user:</span> <span class="hljs-string">animals_readonly</span>
<span class="hljs-attr">    adapter:</span> <span class="hljs-string">mysql</span>
<span class="hljs-attr">    replica:</span> <span class="hljs-literal">true</span>
</code></pre>
<p>When using multiple databases there are a few important settings.</p>
<p>First, the database name for the primary and replica should be the same because they contain
the same data. Second, the username for the primary and replica should be different, and the
replica user's permissions should be to read and not write.</p>
<p>When using a replica database you need to add a <code>replica: true</code> entry to the replica in the
<code>database.yml</code>. This is because Rails otherwise has no way of knowing which one is a replica
and which one is the primary.</p>
<p>Lastly, for new primary databases you need to set the <code>migrations_paths</code> to the directory
where you will store migrations for that database. We'll look more at <code>migrations_paths</code>
later on in this guide.</p>
<p>Now that we have a new database, let's set up the model. In order to use the new database we
need to create a new abstract class and connect to the animals databases.</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AnimalsBase</span> &lt; ApplicationRecord</span>
  <span class="hljs-keyword">self</span>.abstract_class = <span class="hljs-literal">true</span>

  connects_to <span class="hljs-symbol">database:</span> { <span class="hljs-symbol">writing:</span> <span class="hljs-symbol">:animals</span>, <span class="hljs-symbol">reading:</span> <span class="hljs-symbol">:animals_replica</span> }
<span class="hljs-keyword">end</span>
</code></pre>
<p>Then we need to
update <code>ApplicationRecord</code> to be aware of our new replica.</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApplicationRecord</span> &lt; ActiveRecord::Base</span>
  <span class="hljs-keyword">self</span>.abstract_class = <span class="hljs-literal">true</span>

  connects_to <span class="hljs-symbol">database:</span> { <span class="hljs-symbol">writing:</span> <span class="hljs-symbol">:primary</span>, <span class="hljs-symbol">reading:</span> <span class="hljs-symbol">:primary_replica</span> }
<span class="hljs-keyword">end</span>
</code></pre>
<p>By default Rails expects the database roles to be <code>writing</code> and <code>reading</code> for the primary
and replica respectively. If you have a legacy system you may already have roles set up that
you don't want to change. In that case you can set a new role name in your application config.</p>
<pre><code class="hljs css language-ruby">config.active_record.writing_role = <span class="hljs-symbol">:default</span>
config.active_record.reading_role = <span class="hljs-symbol">:readonly</span>
</code></pre>
<p>Now that we have the database.yml and the new model set up it's time to create the databases.
Rails 6.0 ships with all the rails tasks you need to use multiple databases in Rails.</p>
<p>You can run <code>rails -T</code> to see all the commands you're able to run. You should see the following:</p>
<pre><code class="hljs">$ rails -T
rails db:<span class="hljs-keyword">create</span>                          # Creates the <span class="hljs-keyword">database</span> <span class="hljs-keyword">from</span> DATABASE_URL <span class="hljs-keyword">or</span> config/<span class="hljs-keyword">database</span>.yml <span class="hljs-keyword">for</span> the ...
rails db:<span class="hljs-keyword">create</span>:animals                  # <span class="hljs-keyword">Create</span> animals <span class="hljs-keyword">database</span> <span class="hljs-keyword">for</span> current environment
rails db:<span class="hljs-keyword">create</span>:<span class="hljs-keyword">primary</span>                  # <span class="hljs-keyword">Create</span> <span class="hljs-keyword">primary</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">for</span> current environment
rails db:<span class="hljs-keyword">drop</span>                            # Drops the <span class="hljs-keyword">database</span> <span class="hljs-keyword">from</span> DATABASE_URL <span class="hljs-keyword">or</span> config/<span class="hljs-keyword">database</span>.yml <span class="hljs-keyword">for</span> the cu...
rails db:<span class="hljs-keyword">drop</span>:animals                    # <span class="hljs-keyword">Drop</span> animals <span class="hljs-keyword">database</span> <span class="hljs-keyword">for</span> current environment
rails db:<span class="hljs-keyword">drop</span>:<span class="hljs-keyword">primary</span>                    # <span class="hljs-keyword">Drop</span> <span class="hljs-keyword">primary</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">for</span> current environment
rails db:migrate                         # Migrate the <span class="hljs-keyword">database</span> (options: VERSION=x, VERBOSE=<span class="hljs-literal">false</span>, SCOPE=blog)
rails db:migrate:animals                 # Migrate animals <span class="hljs-keyword">database</span> <span class="hljs-keyword">for</span> current environment
rails db:migrate:<span class="hljs-keyword">primary</span>                 # Migrate <span class="hljs-keyword">primary</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">for</span> current environment
rails db:migrate:status                  # Display status of migrations
rails db:migrate:status:animals          # Display status of migrations <span class="hljs-keyword">for</span> animals <span class="hljs-keyword">database</span>
rails db:migrate:status:<span class="hljs-keyword">primary</span>          # Display status of migrations <span class="hljs-keyword">for</span> <span class="hljs-keyword">primary</span> <span class="hljs-keyword">database</span>
</code></pre>
<p>Running a command like <code>rails db:create</code> will create both the primary and animals databases.
Note that there is no command for creating the users and you'll need to do that manually
to support the readonly users for your replicas. If you want to create just the animals
database you can run <code>rails db:create:animals</code>.</p>
<h2><a class="anchor" aria-hidden="true" id="migrations"></a><a href="#migrations" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Migrations</h2>
<p>Migrations for multiple databases should live in their own folders prefixed with the
name of the database key in the configuration.</p>
<p>You also need to set the <code>migrations_paths</code> in the database configurations to tell Rails
where to find the migrations.</p>
<p>For example the <code>animals</code> database would look in the <code>db/animals_migrate</code> directory and
<code>primary</code> would look in <code>db/migrate</code>. Rails generators now take a <code>--database</code> option
so that the file is generated in the correct directory. The command can be run like so:</p>
<pre><code class="hljs">$ rails g migration CreateDogs <span class="hljs-built_in">name</span>:<span class="hljs-built_in">string</span> <span class="hljs-comment">--database animals</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="activating-automatic-connection-switching"></a><a href="#activating-automatic-connection-switching" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Activating automatic connection switching</h2>
<p>Finally, in order to use the read-only replica in your application you'll need to activate
the middleware for automatic switching.</p>
<p>Automatic switching allows the application to switch from the primary to replica or replica
to primary based on the HTTP verb and whether there was a recent write.</p>
<p>If the application is receiving a POST, PUT, DELETE, or PATCH request the application will
automatically write to the primary. For the specified time after the write the application
will read from the replica. For a GET or HEAD request the application will read from the
replica unless there was a recent write.</p>
<p>To activate the automatic connection switching middleware, add or uncomment the following
lines in your application config.</p>
<pre><code class="hljs css language-ruby">config.active_record.database_selector = { <span class="hljs-symbol">delay:</span> <span class="hljs-number">2</span>.seconds }
config.active_record.database_resolver = ActiveRecord::Middleware::DatabaseSelector::Resolver
config.active_record.database_resolver_context = ActiveRecord::Middleware::DatabaseSelector::Resolver::Session
</code></pre>
<p>Rails guarantees &quot;read your own write&quot; and will send your GET or HEAD request to the
primary if it's within the <code>delay</code> window. By default the delay is set to 2 seconds. You
should change this based on your database infrastructure. Rails doesn't guarantee &quot;read
a recent write&quot; for other users within the delay window and will send GET and HEAD requests
to the replicas unless they wrote recently.</p>
<p>The automatic connection switching in Rails is relatively primitive and deliberately doesn't
do a whole lot. The goal was a system that demonstrated how to do automatic connection
switching that was flexible enough to be customizable by app developers.</p>
<p>The setup in Rails allows you to easily change how the switching is done and what
parameters it's based on. Let's say you want to use a cookie instead of a session to
decide when to swap connections. You can write your own class:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyCookieResolver</span></span>
  <span class="hljs-comment"># code for your cookie class</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>And then pass it to the middleware:</p>
<pre><code class="hljs css language-ruby">config.active_record.database_selector = { <span class="hljs-symbol">delay:</span> <span class="hljs-number">2</span>.seconds }
config.active_record.database_resolver = ActiveRecord::Middleware::DatabaseSelector::Resolver
config.active_record.database_resolver_context = MyCookieResolver
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="using-manual-connection-switching"></a><a href="#using-manual-connection-switching" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using manual connection switching</h2>
<p>There are some cases where you may want your application to connect to a primary or a replica
and the automatic connection switching isn't adequate. For example, you may know that for a
particular request you always want to send the request to a replica, even when you are in a
POST request path.</p>
<p>To do this Rails provides a <code>connected_to</code> method that will switch to the connection you
need.</p>
<pre><code class="hljs css language-ruby">ActiveRecord::Base.connected_to(<span class="hljs-symbol">role:</span> <span class="hljs-symbol">:reading</span>) <span class="hljs-keyword">do</span>
  <span class="hljs-comment"># all code in this block will be connected to the reading role</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>The &quot;role&quot; in the <code>connected_to</code> call looks up the connections that are connected on that
connection handler (or role). The <code>reading</code> connection handler will hold all the connections
that were connected via <code>connects_to</code> with the role name of <code>reading</code>.</p>
<p>There also may be a case where you have a database that you don't always want to connect to
on application boot but may need for a slow query or analytics. After defining that database
in the database.yml you can connect by passing a database argument to <code>connected_to</code></p>
<pre><code class="hljs css language-ruby">ActiveRecord::Base.connected_to(<span class="hljs-symbol">database:</span> { <span class="hljs-symbol">reading_slow:</span> <span class="hljs-symbol">:animals_slow_replica</span> }) <span class="hljs-keyword">do</span>
  <span class="hljs-comment"># do something while connected to the slow replica</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>The <code>database</code> argument for <code>connected_to</code> will take a symbol or a config hash.</p>
<p>Note that <code>connected_to</code> with a role will look up an existing connection and switch
using the connection specification name. This means that if you pass an unknown role
like <code>connected_to(role: :nonexistent)</code> you will get an error that says
<code>ActiveRecord::ConnectionNotEstablished (No connection pool with 'AnimalsBase' found for the 'nonexistent' role.)</code></p>
<h2><a class="anchor" aria-hidden="true" id="caveats"></a><a href="#caveats" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Caveats</h2>
<p>As noted at the top, Rails doesn't (yet) support sharding. We had to do a lot of work
to support multiple databases for Rails 6.0. The lack of support for sharding isn't
an oversight, but does require additional work that didn't make it in for 6.0. For now
if you need sharding it may be advisable to continue using one of the many gems
that supports this.</p>
<p>Rails also doesn't support automatic load balancing of replicas. This is very
dependent on your infrastructure. We may implement basic, primitive load balancing
in the future, but for an application at scale this should be something your application
handles outside of Rails.</p>
<p>Lastly, you cannot join across databases. Rails 6.1 will support using <code>has_many</code>
relationships and creating 2 queries instead of joining, but Rails 6.0 will require
you to split the joins into 2 selects manually.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/rails-setup/docs/active%20record%20query"><span class="arrow-prev">← </span><span>Active Record Query Interface</span></a><a class="docs-next button" href="/rails-setup/docs/active%20record%20postgresql"><span class="function-name-prevnext">Active Record and PostgreSQL</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#setting-up-your-application">Setting up your application</a></li><li><a href="#migrations">Migrations</a></li><li><a href="#activating-automatic-connection-switching">Activating automatic connection switching</a></li><li><a href="#using-manual-connection-switching">Using manual connection switching</a></li><li><a href="#caveats">Caveats</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="copyright">Copyright © 2019 Rails Setup</section></footer></div></body></html>